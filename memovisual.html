<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <title>Memoria Visual Pro - Nivells</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #ffdede, #dff7ff);
      min-height: 100vh;
    }
    h1 { margin-top: 30px; color: #222; }
    #nivell { font-size: 22px; margin-top: 10px; color: #222; }
    #cuadros {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      grid-gap: 15px;
      justify-content: center;
      margin-top: 30px;
    }
    .cuadro {
      width: 100px;
      height: 100px;
      background-color: #888;
      border-radius: 12px;
      cursor: pointer;
      transition: transform 0.12s, box-shadow 0.12s, background-color 0.12s;
      display: inline-block;
      box-shadow: 0 4px 8px rgba(0,0,0,0.12);
    }
    .cuadro:active { transform: scale(0.98); }
    #mensaje { font-size: 20px; margin-top: 20px; color: #333; min-height: 26px; }
    .visually-hidden {
      position: absolute;
      left: -10000px;
      top: auto;
      width: 1px;
      height: 1px;
      overflow: hidden;
    }
  </style>
</head>
<body>
  <h1>üß† Memoria Visual Pro</h1>
  <div id="nivell">Nivell: 1</div>
  <div id="cuadros" role="grid" aria-label="Tauler de mem√≤ria"></div>
  <div id="mensaje" role="status" aria-live="polite"></div>
  <div class="visually-hidden" id="instruccio">Repeteix la seq√º√®ncia de colors amb clics o toc.</div>

  <script>
    window.onload = function () {
      // Colors vius per cada quadrat (s'utilitzen quan s'encenen)
      const coloresFijos = [
        "#e53935", "#1e88e5", "#43a047",
        "#ffb300", "#8e24aa", "#d81b60",
        "#00acc1", "#3949ab", "#fb8c00"
      ];

      // Frequ√®ncies (Hz) per cada quadrat
      const frecuencias = [
        440, 523.25, 659.25,
        784, 987.77, 1318.51,
        349.23, 293.66, 587.33
      ];

      const cuadrosContainer = document.getElementById("cuadros");
      const mensaje = document.getElementById("mensaje");
      const nivellTexto = document.getElementById("nivell");

      let secuencia = [];
      let jugador = [];
      let nivell = 1;
      let esperandoInput = false;
      let tiempoLimite;
      let tiempoMaximo = 3500;

      // Llindar per nivell: nivell 1 = 5, nivell 2 = 10, nivell 3 = 15, ...
      function llindarDeNivell(n) {
        return n * 5;
      }

      // Web Audio setup
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      let audioCtx = null;
      function ensureAudioContext() {
        if (!audioCtx) audioCtx = new AudioContext();
      }
      function playTone(freq, duration = 300, type = 'sine') {
        ensureAudioContext();
        const now = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0, now);
        gain.gain.linearRampToValueAtTime(0.14, now + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.001, now + duration / 1000);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start(now);
        osc.stop(now + duration / 1000 + 0.02);
      }

      // Crear 9 quadrats grisos per defecte
      for (let i = 0; i < 9; i++) {
        const cuadro = document.createElement("div");
        cuadro.classList.add("cuadro");
        cuadro.setAttribute("data-id", i);
        cuadro.setAttribute("role", "button");
        cuadro.setAttribute("aria-label", "Quadrat " + (i + 1));
        cuadrosContainer.appendChild(cuadro);
      }

      const cuadros = document.querySelectorAll(".cuadro");

      function nuevaSecuencia() {
        jugador = [];
        esperandoInput = false;
        secuencia.push(Math.floor(Math.random() * 9));
        mostrarSecuencia();
      }

      function iluminarCuadro(id, dur = 300) {
        const cuadro = document.querySelector(`.cuadro[data-id="${id}"]`);
        if (!cuadro) return;
        cuadro.style.backgroundColor = coloresFijos[id];
        cuadro.style.boxShadow = "0 10px 20px rgba(0,0,0,0.25), 0 0 18px " + hexToRgba(coloresFijos[id], 0.35);
        playTone(frecuencias[id], dur);
        setTimeout(() => {
          cuadro.style.boxShadow = "0 4px 8px rgba(0,0,0,0.12)";
          cuadro.style.backgroundColor = "#888";
        }, dur);
      }

      function mostrarSecuencia() {
        let i = 0;
        const intervalo = setInterval(() => {
          const id = secuencia[i];
          iluminarCuadro(id, 300);
          i++;
          if (i >= secuencia.length) {
            clearInterval(intervalo);
            setTimeout(() => {
              esperandoInput = true;
              iniciarTemporizador();
            }, 200);
          }
        }, 500);
      }

      function iniciarTemporizador() {
        clearTimeout(tiempoLimite);
        tiempoLimite = setTimeout(() => {
          perderPorTiempo();
        }, tiempoMaximo);
      }

      function perderPorTiempo() {
        mensaje.innerText = "‚è±Ô∏è Has trigat massa. Reiniciant...";
        secuencia = [];
        nivell = 1;
        nivellTexto.innerText = "Nivell: " + nivell;
        esperandoInput = false;
        setTimeout(() => {
          mensaje.innerText = "";
          nuevaSecuencia();
        }, 1500);
      }

      cuadros.forEach(cuadro => {
        cuadro.addEventListener("click", () => {
          ensureAudioContext();
          if (!esperandoInput) return;
          clearTimeout(tiempoLimite);
          const id = parseInt(cuadro.getAttribute("data-id"));
          jugador.push(id);
          // mostrar color viu breument i reproduir so
          cuadro.style.backgroundColor = coloresFijos[id];
          cuadro.style.boxShadow = "0 10px 20px rgba(0,0,0,0.25), 0 0 14px " + hexToRgba(coloresFijos[id], 0.32);
          playTone(frecuencias[id], 220);
          setTimeout(() => {
            cuadro.style.boxShadow = "0 4px 8px rgba(0,0,0,0.12)";
            cuadro.style.backgroundColor = "#888";
          }, 220);
          verificar();
        });

        cuadro.tabIndex = 0;
        cuadro.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            cuadro.click();
          }
        });
      });

      function verificar() {
        for (let i = 0; i < jugador.length; i++) {
          if (jugador[i] !== secuencia[i]) {
            mensaje.innerText = "‚ùå Has fallat. Reiniciant...";
            secuencia = [];
            nivell = 1;
            nivellTexto.innerText = "Nivell: " + nivell;
            esperandoInput = false;
            setTimeout(() => {
              mensaje.innerText = "";
              nuevaSecuencia();
            }, 1500);
            return;
          }
        }

        // Si completa l'intent actual, afegim un nou pas a la seq√º√®ncia
        if (jugador.length === secuencia.length) {
          // comprovar si hem arribat al llindar del nivell actual
          if (secuencia.length >= llindarDeNivell(nivell)) {
            nivell++;
            nivellTexto.innerText = "Nivell: " + nivell;
            mensaje.innerText = "üîì Nivell " + (nivell - 1) + " completat! Nou nivell " + nivell + ".";
            // breu pausa perqu√® l'usuari vegi el missatge
            setTimeout(() => { mensaje.innerText = ""; nuevaSecuencia(); }, 1200);
            return;
          }
          // si no s'arriba al llindar, simplement continuar i afegir a seq√º√®ncia
          mensaje.innerText = "‚úÖ B√©!";
          esperandoInput = false;
          setTimeout(() => {
            mensaje.innerText = "";
            nuevaSecuencia();
          }, 700);
        } else {
          iniciarTemporizador();
        }
      }

      // utilitat per crear un rgba basat en el hex
      function hexToRgba(hex, alpha) {
        const h = hex.replace('#','');
        const r = parseInt(h.substring(0,2),16);
        const g = parseInt(h.substring(2,4),16);
        const b = parseInt(h.substring(4,6),16);
        return 'rgba(' + r + ',' + g + ',' + b + ',' + alpha + ')';
      }

      nuevaSecuencia();
    };
  </script>
</body>
</html>
```
