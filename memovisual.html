<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <title>Memoria Visual Pro - Pausa amb ESC</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg1: #ffdede;
      --bg2: #dff7ff;
      --panel: rgba(255,255,255,0.95);
      --gris: #888;
    }
    html,body { height:100%; margin:0; }
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      padding:18px;
    }
    .container {
      width: 820px;
      max-width: 100%;
      background: var(--panel);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
      position: relative;
      overflow: visible;
    }
    h1 { margin: 6px 0 12px; color: #222; }
    .btn {
      background:#fff;
      border:2px solid #eee;
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      box-shadow:0 6px 12px rgba(0,0,0,0.06);
      transition: transform .08s, box-shadow .12s;
    }
    .btn:active { transform:translateY(1px) scale(.995); }
    #info { display:flex; gap:20px; align-items:center; justify-content:space-between; margin: 10px 0 18px; flex-wrap:wrap; }
    #nivell { font-size:18px; color:#222; }
    #mensaje { font-size:16px; color:#333; min-height:22px; }
    #boardWrap { display:flex; justify-content:center; }
    #cuadros {
      display:grid;
      grid-gap:12px;
      justify-content:center;
      align-content:center;
      margin-top:6px;
    }
    .cuadro {
      width: 90px;
      height: 90px;
      background-color: var(--gris);
      border-radius: 12px;
      cursor: pointer;
      transition: transform 0.12s, box-shadow 0.12s, background-color 0.12s;
      box-shadow: 0 4px 8px rgba(0,0,0,0.12);
      user-select:none;
      -webkit-user-select:none;
    }
    .cuadro:active { transform: scale(0.98); }
    .cuadro.wrong {
      box-shadow: 0 10px 30px rgba(0,0,0,0.28) !important;
      transform: scale(0.99);
    }
    .visually-hidden { position: absolute; left: -10000px; top: auto; width: 1px; height: 1px; overflow: hidden; }
    footer { margin-top:14px; color:#666; font-size:13px; }

    /* Overlay (√∫s compartit per start, pausa i game over) */
    .overlay {
      position: absolute;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,0.45);
      z-index: 30;
      border-radius: 12px;
    }
    .start-panel {
      background: #fff;
      padding: 22px;
      border-radius: 12px;
      width: 520px;
      max-width: calc(100% - 40px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.28);
      text-align: center;
    }
    .size-options {
      display:flex;
      justify-content:center;
      gap:12px;
      margin: 14px 0;
      flex-wrap:wrap;
    }
    .size-option {
      padding:10px 14px;
      background:#f6f7fb;
      border-radius:10px;
      border:2px solid transparent;
      cursor:pointer;
      font-weight:700;
      user-select:none;
    }
    .size-option.selected {
      border-color:#1e88e5;
      background: linear-gradient(180deg,#eaf4ff,#fff);
    }
    .small { font-size:13px; color:#555; }

    .pause-level {
      font-size:34px;
      font-weight:800;
      margin: 6px 0 8px;
      color:#222;
    }

    .pause-buttons { display:flex; gap:10px; justify-content:center; margin-top:12px; flex-wrap:wrap; }

    @media (max-width:520px) {
      .cuadro { width: 64px; height:64px; border-radius:10px; }
      .start-panel { width: 92%; padding:16px; }
      .pause-level { font-size:26px; }
    }
  </style>
</head>
<body>
  <div class="container" role="application" aria-label="Memoria Visual Pro">
    <h1>üß† Memoria Visual Pro</h1>

    <div id="info">
      <div id="nivell">Nivell: 1</div>
      <div id="status">
        <span id="mensaje" role="status" aria-live="polite"></span>
      </div>
    </div>

    <div id="boardWrap">
      <div id="cuadros" role="grid" aria-label="Tauler de mem√≤ria"></div>
    </div>

    <div class="visually-hidden" id="instruccio">Repeteix la seq√º√®ncia de colors amb clics o toc.</div>
    <footer>Prem ESC per obrir el men√∫ de pausa</footer>

    <!-- OVERLAY d'inici -->
    <div class="overlay" id="startOverlay" role="dialog" aria-modal="true" aria-label="Pantalla d'inici">
      <div class="start-panel">
        <h2>Comen√ßar partida</h2>
        <p class="small">Tria la mida de la graella i prem <strong>Comen√ßar</strong></p>

        <div class="size-options" role="radiogroup" aria-label="Mida de la graella">
          <div class="size-option" data-size="4" role="radio" aria-checked="false" tabindex="0">2√ó2 (4)</div>
          <div class="size-option selected" data-size="9" role="radio" aria-checked="true" tabindex="0">3√ó3 (9)</div>
          <div class="size-option" data-size="16" role="radio" aria-checked="false" tabindex="0">4√ó4 (16)</div>
        </div>

        <div style="margin-top:12px;">
          <button class="btn" id="startBtn">Comen√ßar</button>
        </div>

        <p class="small" style="margin-top:12px;color:#666">Pots pr√©mer ESC per pausar durant el joc</p>
      </div>
    </div>

    <!-- OVERLAY de pausa (mateixa mida que el d'inici) -->
    <div class="overlay" id="pauseOverlay" role="dialog" aria-modal="true" aria-label="Pausa" style="display:none;">
      <div class="start-panel">
        <h2>Pausa</h2>
        <div class="pause-level" id="pauseLevelText">Nivell 1</div>
        <div class="pause-buttons">
          <button class="btn" id="resumeBtn">Continuar</button>
          <button class="btn" id="restartSameBtn">Reinicia mateixes</button>
          <button class="btn" id="toStartBtn">Torna a l'inici</button>
        </div>
      </div>
    </div>

    <!-- OVERLAY de final de partida -->
    <div class="overlay" id="gameOverOverlay" role="dialog" aria-modal="true" aria-label="Has perdut" style="display:none;">
      <div class="start-panel">
        <h2>Has perdut!</h2>
        <p class="small">T‚Äôhas quedat al nivell <strong id="finalLevel">1</strong></p>
        <p class="small" id="finalSeqInfo" style="margin-top:6px;color:#666"></p>
        <div style="margin-top:12px;">
          <button class="btn" id="retryBtn">Torna a l'inici</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    window.onload = function () {
      // UI
      const startOverlay = document.getElementById('startOverlay');
      const startBtn = document.getElementById('startBtn');
      const sizeOptions = document.querySelectorAll('.size-option');
      const cuadrosContainer = document.getElementById('cuadros');
      const mensaje = document.getElementById('mensaje');
      const nivellTexto = document.getElementById('nivell');

      const pauseOverlay = document.getElementById('pauseOverlay');
      const pauseLevelText = document.getElementById('pauseLevelText');
      const resumeBtn = document.getElementById('resumeBtn');
      const restartSameBtn = document.getElementById('restartSameBtn');
      const toStartBtn = document.getElementById('toStartBtn');

      const gameOverOverlay = document.getElementById('gameOverOverlay');
      const finalLevelEl = document.getElementById('finalLevel');
      const finalSeqInfo = document.getElementById('finalSeqInfo');
      const retryBtn = document.getElementById('retryBtn');

      // Estat i configuraci√≥
      let size = 9;
      let cols = 3;
      let coloresFijos = [];
      let frecuencias = [];
      let baseStep = 3; // s'assigna en setupBoard segons mida

      let secuencia = [];
      let jugador = [];
      let nivell = 1;
      let esperandoInput = false;
      let jugantSequencia = false;
      let paused = false;
      let tiempoLimite;
      const tiempoMaximo = 3500;

      // Map per timeouts per quadrat
      const cuadroTimeouts = new Map();

      // Audio
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      let audioCtx = null;
      function ensureAudioContext() { if (!audioCtx) audioCtx = new AudioContext(); }
      function playTone(freq, duration = 300, type = 'sine') {
        ensureAudioContext();
        const now = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0, now);
        gain.gain.linearRampToValueAtTime(0.14, now + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.001, now + duration / 1000);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start(now);
        osc.stop(now + duration / 1000 + 0.02);
      }

      // Helpers
      function hexToRgba(hex, alpha) {
        const h = hex.replace('#','');
        const r = parseInt(h.substring(0,2),16);
        const g = parseInt(h.substring(2,4),16);
        const b = parseInt(h.substring(4,6),16);
        return 'rgba(' + r + ',' + g + ',' + b + ',' + alpha + ')';
      }

      function llindarDeNivell(n) { return n * baseStep; }

      function generarColors(n) {
        const baseHue = [0, 200, 120, 38, 270, 330, 180, 230, 28, 15, 260, 300, 45, 80, 160, 210];
        const colors = [];
        for (let i = 0; i < n; i++) {
          const hue = baseHue[i % baseHue.length];
          colors.push(hslToHex((hue + (i*13)) % 360, 75, 50));
        }
        return colors;
      }
      function hslToHex(h, s, l) {
        s /= 100; l /= 100;
        const k = n => (n + h / 30) % 12;
        const a = s * Math.min(l, 1 - l);
        const f = n => {
          const color = l - a * Math.max(-1, Math.min(k(n) - 3, Math.min(9 - k(n), 1)));
          return Math.round(255 * color).toString(16).padStart(2, '0');
        };
        return `#${f(0)}${f(8)}${f(4)}`;
      }
      function generarFrecuencias(n) {
        const base = [440, 494, 523.25, 587.33, 659.25, 740, 830, 880, 987.77, 1108.73, 1244.51, 1318.51, 1479.98, 1568, 1760, 1975.53];
        const frecs = [];
        for (let i = 0; i < n; i++) frecs.push(base[i % base.length]);
        return frecs;
      }

      // -------- Construcci√≥ del tauler (no inicia el joc) --------
      function setupBoard(n) {
        size = n;
        if (n === 4) cols = 2;
        else if (n === 9) cols = 3;
        else cols = 4;

        if (n === 4) baseStep = 2;
        else if (n === 9) baseStep = 3;
        else baseStep = 4;

        coloresFijos = generarColors(size);
        frecuencias = generarFrecuencias(size);
        cuadrosContainer.innerHTML = '';
        cuadrosContainer.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
        for (let i = 0; i < size; i++) {
          const cuadro = document.createElement('div');
          cuadro.classList.add('cuadro');
          cuadro.setAttribute('data-id', i);
          cuadro.setAttribute('role', 'button');
          cuadro.setAttribute('aria-label', 'Quadrat ' + (i + 1));
          cuadro.tabIndex = 0;
          cuadrosContainer.appendChild(cuadro);
        }
        attachListeners();
      }

      function attachListeners() {
        const cuadros = document.querySelectorAll('.cuadro');
        cuadros.forEach(cuadro => {
          cuadro.removeEventListener('click', onCuadroClick);
          cuadro.addEventListener('click', onCuadroClick);
          cuadro.addEventListener('keydown', e => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              cuadro.click();
            }
          });
        });
      }

      // -------- Funcions de color i feedback per-element (evita quedar marcat) --------
      function clearCuadroTimeout(id) {
        if (cuadroTimeouts.has(id)) {
          clearTimeout(cuadroTimeouts.get(id));
          cuadroTimeouts.delete(id);
        }
      }

      function iluminarCuadro(id, dur = 300) {
        const cuadro = document.querySelector(`.cuadro[data-id="${id}"]`);
        if (!cuadro) return;
        clearCuadroTimeout(id);
        cuadro.style.backgroundColor = coloresFijos[id];
        cuadro.style.boxShadow = "0 10px 20px rgba(0,0,0,0.25), 0 0 18px " + hexToRgba(coloresFijos[id], 0.35);
        playTone(frecuencias[id], dur);
        const t = setTimeout(() => {
          cuadro.style.boxShadow = "0 4px 8px rgba(0,0,0,0.12)";
          cuadro.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--gris').trim() || '#888';
          cuadroTimeouts.delete(id);
        }, dur);
        cuadroTimeouts.set(id, t);
      }

      function feedbackLocalCuadro(cuadroEl, id) {
        clearCuadroTimeout(id);
        cuadroEl.style.backgroundColor = coloresFijos[id];
        cuadroEl.style.boxShadow = "0 10px 20px rgba(0,0,0,0.25), 0 0 14px " + hexToRgba(coloresFijos[id], 0.32);
        playTone(frecuencias[id], 220);
        const t = setTimeout(() => {
          cuadroEl.style.boxShadow = "0 4px 8px rgba(0,0,0,0.12)";
          cuadroEl.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--gris').trim() || '#888';
          cuadroTimeouts.delete(id);
        }, 220);
        cuadroTimeouts.set(id, t);
      }

      // -------- L√≤gica del joc --------
      function iniciarJoc() {
        secuencia = [];
        jugador = [];
        nivell = 1;
        nivellTexto.innerText = 'Nivell: ' + nivell;
        mensaje.innerText = '';
        esperandoInput = false;
        jugantSequencia = false;
        paused = false;
        startOverlay.style.display = 'none';
        pauseOverlay.style.display = 'none';
        gameOverOverlay.style.display = 'none';
        // seq√º√®ncia inicial d'1 pas
        secuencia.push(Math.floor(Math.random() * size));
        mostrarSecuencia();
      }

      function nuevaSecuenciaUnaPas() {
        jugador = [];
        esperandoInput = false;
        jugantSequencia = true;
        secuencia.push(Math.floor(Math.random() * size));
        mostrarSecuencia();
      }

      function mostrarSecuencia() {
        let i = 0;
        jugantSequencia = true;
        const interval = setInterval(() => {
          const id = secuencia[i];
          iluminarCuadro(id, 300);
          i++;
          if (i >= secuencia.length) {
            clearInterval(interval);
            setTimeout(() => {
              jugador = [];
              jugantSequencia = false;
              if (!paused) {
                esperandoInput = true;
                iniciarTemporizador();
              }
            }, 220);
          }
        }, 500);
      }

      function onCuadroClick(e) {
        ensureAudioContext();
        // bloquejar entrades si es reprodueix seq√º√®ncia, si estem pausats o no estem esperant input
        if (jugantSequencia || paused || !esperandoInput) return;
        clearTimeout(tiempoLimite);
        const id = parseInt(e.currentTarget.getAttribute('data-id'));
        jugador.push(id);

        const currentIndex = jugador.length - 1;
        if (secuencia[currentIndex] !== id) {
          // mostrar feedback equivocat, deixar missatge i despr√©s mostrar overlay de final
          clearCuadroTimeout(id);
          const el = e.currentTarget;
          el.classList.add('wrong');
          el.style.backgroundColor = coloresFijos[id];
          el.style.boxShadow = "0 10px 30px rgba(0,0,0,0.35), 0 0 20px " + hexToRgba(coloresFijos[id], 0.4);
          playTone(220, 350, 'sawtooth');
          mensaje.innerText = "‚ùå Has fallat...";
          esperandoInput = false;
          jugantSequencia = false;
          // retard abans d'anar a la pantalla de mort
          setTimeout(() => {
            clearCuadroTimeout(id);
            el.classList.remove('wrong');
            el.style.boxShadow = "0 4px 8px rgba(0,0,0,0.12)";
            el.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--gris').trim() || '#888';
            mostrarGameOver();
            setTimeout(() => { mensaje.innerText = ''; }, 700);
          }, 700);
          return;
        }

        // correcte
        feedbackLocalCuadro(e.currentTarget, id);
        verificar();
      }

      function iniciarTemporizador() {
        clearTimeout(tiempoLimite);
        tiempoLimite = setTimeout(() => { perderPerTemps(); }, tiempoMaximo);
      }

      function mostrarGameOver() {
        finalLevelEl.innerText = nivell;
        finalSeqInfo.innerText = 'Longitud de la seq√º√®ncia: ' + secuencia.length;
        gameOverOverlay.style.display = 'flex';
      }

      function perderPerTemps() {
        if (paused) return;
        esperandoInput = false;
        jugantSequencia = false;
        mensaje.innerText = "‚è±Ô∏è Has trigat massa...";
        setTimeout(() => {
          mensaje.innerText = '';
          mostrarGameOver();
        }, 700);
      }

      function verificar() {
        for (let i = 0; i < jugador.length; i++) {
          if (jugador[i] !== secuencia[i]) {
            esperandoInput = false;
            jugantSequencia = false;
            mostrarGameOver();
            return;
          }
        }

        if (jugador.length === secuencia.length) {
          if (secuencia.length >= llindarDeNivell(nivell)) {
            const nivellAnterior = nivell;
            nivell++;
            nivellTexto.innerText = 'Nivell: ' + nivell;
            mensaje.innerText = "üîì Nivell " + nivellAnterior + " completat! Comen√ßa Nivell " + nivell + ".";
            secuencia = [];
            jugador = [];
            esperandoInput = false;
            jugantSequencia = true;
            setTimeout(() => {
              mensaje.innerText = '';
              secuencia.push(Math.floor(Math.random() * size));
              mostrarSecuencia();
            }, 900);
            return;
          }

          mensaje.innerText = "‚úÖ B√©!";
          esperandoInput = false;
          jugantSequencia = true;
          setTimeout(() => {
            mensaje.innerText = '';
            secuencia.push(Math.floor(Math.random() * size));
            mostrarSecuencia();
          }, 700);
        } else {
          iniciarTemporizador();
        }
      }

      // ---------- Pausa amb ESC ----------
      function openPause() {
        if (startOverlay.style.display !== 'none' || gameOverOverlay.style.display === 'flex') return;
        paused = true;
        // aturar temporitzador
        clearTimeout(tiempoLimite);
        pauseLevelText.innerText = 'Nivell ' + nivell;
        pauseOverlay.style.display = 'flex';
      }

      function closePause() {
        pauseOverlay.style.display = 'none';
        paused = false;
        // si est√†vem en espera, reiniciar temporitzador
        if (esperandoInput) iniciarTemporizador();
      }

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          // si est√† visible el gameOverOverlay, ESC no fa pause
          if (gameOverOverlay.style.display === 'flex') return;
          if (pauseOverlay.style.display === 'flex') closePause();
          else openPause();
        }
      });

      resumeBtn.addEventListener('click', () => {
        closePause();
      });

      restartSameBtn.addEventListener('click', () => {
        // reiniciar amb la mateixa graella: tancar pausa i reiniciar joc
        pauseOverlay.style.display = 'none';
        paused = false;
        iniciarJoc();
      });

      toStartBtn.addEventListener('click', () => {
        // tancar pausa i mostrar pantalla d'inici (mant√© mida seleccionada actual)
        pauseOverlay.style.display = 'none';
        paused = false;
        startOverlay.style.display = 'flex';
      });

      // ---------- Interaccions overlays i reinici final ----------
      sizeOptions.forEach(opt => {
        opt.addEventListener('click', () => {
          sizeOptions.forEach(o => { o.classList.remove('selected'); o.setAttribute('aria-checked','false'); });
          opt.classList.add('selected');
          opt.setAttribute('aria-checked','true');
          size = parseInt(opt.getAttribute('data-size'));
        });
        opt.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); opt.click(); }
        });
      });

      startBtn.addEventListener('click', () => {
        setupBoardAndStart(size);
      });

      retryBtn.addEventListener('click', () => {
        // al game over: portar a la pantalla d'inici
        gameOverOverlay.style.display = 'none';
        startOverlay.style.display = 'flex';
      });

      // reiniciar mateixes (no mostrem bot√≥ durant el joc)
      // funci√≥ d'inici general
      function setupBoardAndStart(n) {
        setupBoard(n);
        startOverlay.style.display = 'none';
        iniciarJoc();
      }

      // Setup board sense iniciar
      function setupBoard(n) {
        size = n;
        if (n === 4) cols = 2;
        else if (n === 9) cols = 3;
        else cols = 4;

        if (n === 4) baseStep = 2;
        else if (n === 9) baseStep = 3;
        else baseStep = 4;

        coloresFijos = generarColors(size);
        frecuencias = generarFrecuencias(size);
        cuadrosContainer.innerHTML = '';
        cuadrosContainer.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
        for (let i = 0; i < size; i++) {
          const cuadro = document.createElement('div');
          cuadro.classList.add('cuadro');
          cuadro.setAttribute('data-id', i);
          cuadro.setAttribute('role', 'button');
          cuadro.setAttribute('aria-label', 'Quadrat ' + (i + 1));
          cuadro.tabIndex = 0;
          cuadrosContainer.appendChild(cuadro);
        }
        attachListeners();
      }

      // Inicialitzaci√≥ per defecte: prepara la vista i mostra overlay d'inici
      setupBoard(9);
      startOverlay.style.display = 'flex';
      mensaje.innerText = 'Tria la mida i prem Comen√ßar';
    };
  </script>
</body>
</html>
