<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <title>Memoria Visual Pro | GLS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="assets/favicon.png" type="image/png" />
  <style>
    :root{
      --page-accent: #21BCFF;
      --bg-panel: #0f1720;
      --panel-contrast: #0d141a;
      --muted: #94a3b8;
      --text: #e6eef8;
      --accent: #3b82f6;
      --gris: #344052;
      --shadow: rgba(0,0,0,0.6);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body { height: 100%; }

    body{
      background-color: #002244;
        var(--page-accent);
      color: var(--text);
      font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
    }

    nav {
      background-color: rgba(0, 0, 0, 0.7);
      position: sticky;
      top: 0;
      width: 100%;
      z-index: 100;
      padding: 1rem 2rem;
    }

    nav ul {
      list-style: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    nav li.logo {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    nav li.logo img { height: 60px; vertical-align: middle; }

    .nav-enllac {
      color: white;
      text-decoration: none;
      font-weight: bold;
      font-size: 1rem;
      transition: color 0.3s;
    }

    .nav-enllac:hover { color: #ffff66; }

    .inici-ajustada { margin-left: 1rem; }

    nav li.enllacos { display: flex; gap: 2rem; }

    /* container visual i layout del joc (no canvia mides del joc) */
    .page-wrap {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: calc(100vh - 80px);
      padding: 18px;
    }

    .container{
      width: 820px;
      max-width: 100%;
      background: linear-gradient(180deg,var(--bg-panel), var(--panel-contrast));
      border-radius:12px;
      padding:20px;
      box-shadow: 0 14px 40px rgba(2,6,23,0.6);
      position:relative;
      overflow:visible;
      border: 1px solid rgba(255,255,255,0.03);
    }

    h1{ margin:6px 0 12px; color:var(--text); font-weight:700; letter-spacing:0.2px; text-align:center }

    #info{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px;flex-wrap:wrap}
    #nivell{font-size:18px;color:var(--text);font-weight:600}
    #mensaje{font-size:15px;min-height:22px;color:var(--muted)}

    #boardWrap{display:flex;justify-content:center}
    #cuadros{display:grid;grid-gap:12px;margin-top:6px;justify-content:center;align-content:center}

    .cuadro{
      width:90px;
      height:90px;
      background: var(--gris);
      border-radius:12px;
      box-shadow: 0 6px 18px rgba(2,6,23,0.6);
      transition: box-shadow .12s, transform .12s, background-color .12s;
      cursor:pointer;
      user-select:none;
    }
    .cuadro:active{ transform: scale(.98) }
    .cuadro.wrong{ box-shadow: 0 14px 36px rgba(0,0,0,0.7) !important; }

    footer{margin-top:14px;color:var(--muted);text-align:center;font-size:13px}

    /* overlays */
    #startOverlay{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(2,6,23,0.96);
      z-index:40;
      border-radius:12px;
    }
    #startOverlay .panel{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.08);
      color: var(--text);
      padding:22px;
      border-radius:14px;
      width:520px;
      max-width:calc(100% - 40px);
      box-shadow: 0 28px 80px rgba(2,6,23,0.85);
      text-align:center;
    }

    #pauseOverlay, #gameOverOverlay{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(3,7,12,0.60);
      z-index:35;
      border-radius:12px;
      backdrop-filter: blur(4px);
    }
    #pauseOverlay .panel, #gameOverOverlay .panel{
      background: linear-gradient(180deg, #0b1220, #0d1418);
      border: 1px solid rgba(255,255,255,0.06);
      color: var(--text);
      padding:22px;
      border-radius:14px;
      width:520px;
      max-width:calc(100% - 40px);
      box-shadow: 0 22px 64px rgba(2,6,23,0.7);
      text-align:center;
    }

    .size-options{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin:14px 0}
    .size-option{
      padding:10px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      border-radius:10px;
      border: 1px solid rgba(255,255,255,0.04);
      cursor:pointer;
      font-weight:700;
      color:var(--text);
      user-select:none;
    }
    .size-option.selected{
      outline: 2px solid rgba(59,130,246,0.20);
      box-shadow: 0 12px 28px rgba(59,130,246,0.08);
      background: linear-gradient(180deg, rgba(59,130,246,0.06), rgba(255,255,255,0.01));
    }

    .small{ font-size:13px; color:var(--muted) }

    .btn{
      background: linear-gradient(180deg, var(--accent), #2367d9);
      color: #ffffff;
      border: none;
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      box-shadow: 0 12px 28px rgba(37,99,235,0.16);
      transition: transform .08s, box-shadow .12s, opacity .12s;
    }
    .btn:hover{ transform: translateY(-2px) }
    .btn:active{ transform: translateY(0) scale(.995) }

    .btn.ghost{
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.06);
      color: var(--text);
      box-shadow: none;
    }

    .pause-level{ font-size:34px; font-weight:800; margin:6px 0 8px; color:var(--text) }
    .pause-buttons{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:12px }

    @media (max-width:520px){
      .cuadro{ width:64px; height:64px; border-radius:10px }
      .panel{ width:92%; padding:16px }
      .pause-level{ font-size:26px }
    }
  </style>
</head>
<body>
  <nav>
    <ul>
      <li class="logo">
        <a href="https://lagg.netlify.app">
          <img src="assets/logo.png" alt="Logo GLS" />
        </a>
      </li>
      <li class="enllacos">
         <a class="nav-enllac" href="https://lagg.netlify.app">Inici</a>
        <a class="nav-enllac" href="https://lagg.netlify.app/contacte">Contactar</a>
      </li>
    </ul>
  </nav>

  <div class="page-wrap">
    <div class="container" role="application" aria-label="Memoria Visual Pro">
      <h1>üß† Memoria Visual Pro</h1>

      <div id="info">
        <div id="nivell">Nivell: 1</div>
        <div id="mensaje" role="status" aria-live="polite"></div>
      </div>

      <div id="boardWrap"><div id="cuadros" role="grid" aria-label="Tauler de mem√≤ria"></div></div>
      <footer>Prem ESC per obrir el men√∫ de pausa</footer>

      <!-- START overlay (OPAC) -->
      <div id="startOverlay" role="dialog" aria-modal="true" aria-label="Pantalla d'inici">
        <div class="panel">
          <h2 style="margin:0 0 8px;color:var(--text)">Comen√ßar partida</h2>
          <p class="small" style="color:var(--muted)">Tria la mida de la graella i prem <strong style="color:var(--text)">Comen√ßar</strong></p>
          <div class="size-options" role="radiogroup" aria-label="Mida de la graella">
            <div class="size-option" data-size="4" role="radio" aria-checked="false" tabindex="0">2√ó2 (4)</div>
            <div class="size-option selected" data-size="9" role="radio" aria-checked="true" tabindex="0">3√ó3 (9)</div>
            <div class="size-option" data-size="16" role="radio" aria-checked="false" tabindex="0">4√ó4 (16)</div>
          </div>
          <div style="margin-top:12px"><button class="btn" id="startBtn">Comen√ßar</button></div>
          <p class="small" style="margin-top:12px;color:var(--muted)">Pots pr√©mer ESC per pausar durant el joc</p>
        </div>
      </div>

      <!-- PAUSE overlay (fons semitransparent, panel OPAC) -->
      <div id="pauseOverlay" style="display:none" role="dialog" aria-modal="true" aria-label="Pausa">
        <div class="panel">
          <h2 style="margin:0 0 8px;color:var(--text)">Pausa</h2>
          <div class="pause-level" id="pauseLevelText">Nivell 1</div>
          <div class="pause-buttons">
            <button class="btn" id="resumeBtn">Continuar</button>
            <button class="btn ghost" id="restartSameBtn">Reinicia mateixes</button>
            <button class="btn ghost" id="toStartBtn">Torna a l'inici</button>
          </div>
        </div>
      </div>

      <!-- GAME OVER overlay (fons semitransparent, panel OPAC) -->
      <div id="gameOverOverlay" style="display:none" role="dialog" aria-modal="true" aria-label="Has perdut">
        <div class="panel">
          <h2 style="margin:0 0 8px;color:var(--text)">Has perdut!</h2>
          <p class="small">T‚Äôhas quedat al nivell <strong id="finalLevel">1</strong></p>
          <p class="small" id="finalSeqInfo" style="margin-top:6px;color:var(--muted)"></p>
          <div style="margin-top:12px"><button class="btn" id="retryBtn">Torna a l'inici</button></div>
        </div>
      </div>

    </div> <!-- tanca .container -->
  </div> <!-- tanca .page-wrap -->


  <script>
    window.onload = function () {
      // Elements
      const startOverlay = document.getElementById('startOverlay');
      const sizeOptions = document.querySelectorAll('.size-option');
      const startBtn = document.getElementById('startBtn');
      const cuadrosContainer = document.getElementById('cuadros');
      const mensaje = document.getElementById('mensaje');
      const nivellTexto = document.getElementById('nivell');

      const pauseOverlay = document.getElementById('pauseOverlay');
      const pauseLevelText = document.getElementById('pauseLevelText');
      const resumeBtn = document.getElementById('resumeBtn');
      const restartSameBtn = document.getElementById('restartSameBtn');
      const toStartBtn = document.getElementById('toStartBtn');

      const gameOverOverlay = document.getElementById('gameOverOverlay');
      const finalLevelEl = document.getElementById('finalLevel');
      const finalSeqInfo = document.getElementById('finalSeqInfo');
      const retryBtn = document.getElementById('retryBtn');

      // State
      let size = 9, cols = 3, baseStep = 3;
      let coloresFijos = [], frecuencias = [];
      let secuencia = [], jugador = [];
      let nivell = 1;
      let esperandoInput = false;
      let paused = false;

      // Timers / playback control
      const TIEMPO_MAX = 3500;
      let inputTimer = null;
      let seqInterval = null;
      let playIndex = 0;
      let wasPlayingWhenPaused = false;

      const cuadroTimeouts = new Map();

      // Audio
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      let audioCtx = null;
      function ensureAudioCtx(){ if(!audioCtx) audioCtx = new AudioContext(); }
      function playTone(freq,duration=300,type='sine'){ ensureAudioCtx(); const now=audioCtx.currentTime; const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type=type; o.frequency.value=freq; g.gain.setValueAtTime(0,now); g.gain.linearRampToValueAtTime(0.14,now+0.01); g.gain.exponentialRampToValueAtTime(0.001,now+duration/1000); o.connect(g); g.connect(audioCtx.destination); o.start(now); o.stop(now+duration/1000+0.02); }

      // Utils color/freq
      function hexToRgba(hex,a){ const h=hex.replace('#',''); const r=parseInt(h.slice(0,2),16); const g=parseInt(h.slice(2,4),16); const b=parseInt(h.slice(4,6),16); return `rgba(${r},${g},${b},${a})`; }
      function hslToHex(h,s,l){ s/=100; l/=100; const k=n=> (n + h/30) % 12; const a=s*Math.min(l,1-l); const f=n=>{ const color = l - a * Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n),1))); return Math.round(255*color).toString(16).padStart(2,'0'); }; return `#${f(0)}${f(8)}${f(4)}`; }
      function generarColors(n){ const base=[0,200,120,38,270,330,180,230,28,15,260,300,45,80,160,210]; const out=[]; for(let i=0;i<n;i++){ const hue=base[i%base.length]; out.push(hslToHex((hue + i*13)%360,75,50)); } return out; }
      function generarFrecuencias(n){ const base=[440,494,523.25,587.33,659.25,740,830,880,987.77,1108.73,1244.51,1318.51,1479.98,1568,1760,1975.53]; return Array.from({length:n},(_,i)=>base[i%base.length]); }
      function llindarDeNivell(n){ return n * baseStep; }

      // Build grid
      function setupBoard(n){
        size = n;
        if(size===4) cols=2; else if(size===9) cols=3; else cols=4;
        baseStep = (size===4?2: size===9?3:4);
        coloresFijos = generarColors(size);
        frecuencias = generarFrecuencias(size);
        cuadrosContainer.innerHTML = '';
        cuadrosContainer.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
        for(let i=0;i<size;i++){
          const d = document.createElement('div');
          d.className = 'cuadro';
          d.setAttribute('data-id', i);
          d.setAttribute('role','button');
          d.setAttribute('aria-label','Quadrat '+(i+1));
          d.tabIndex = 0;
          cuadrosContainer.appendChild(d);
        }
        attachListeners();
      }

      function attachListeners(){
        const nodes = document.querySelectorAll('.cuadro');
        nodes.forEach(n=>{
          n.removeEventListener('click', onCuadroClick);
          n.addEventListener('click', onCuadroClick);
          n.removeEventListener('keydown', onCuadroKey);
          n.addEventListener('keydown', onCuadroKey);
        });
      }
      function onCuadroKey(e){ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); e.currentTarget.click(); } }

      function clearCuadroTimeout(id){ if(cuadroTimeouts.has(id)){ clearTimeout(cuadroTimeouts.get(id)); cuadroTimeouts.delete(id); } }
      function iluminarCuadro(id,dur=300){
        const el = document.querySelector(`.cuadro[data-id="${id}"]`);
        if(!el) return;
        clearCuadroTimeout(id);
        el.style.backgroundColor = coloresFijos[id];
        el.style.boxShadow = "0 10px 20px rgba(0,0,0,0.45), 0 0 18px " + hexToRgba(coloresFijos[id], .28);
        playTone(frecuencias[id], dur);
        const t = setTimeout(()=>{ if(el){ el.style.boxShadow="0 6px 18px rgba(0,0,0,.45)"; el.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--gris').trim() || '#344052'; } cuadroTimeouts.delete(id); }, dur);
        cuadroTimeouts.set(id, t);
      }
      function feedbackLocalCuadro(el,id){
        clearCuadroTimeout(id);
        el.style.backgroundColor = coloresFijos[id];
        el.style.boxShadow = "0 10px 20px rgba(0,0,0,0.45), 0 0 14px "+hexToRgba(coloresFijos[id],.28);
        playTone(frecuencias[id],220);
        const t = setTimeout(()=>{ if(el){ el.style.boxShadow="0 6px 18px rgba(0,0,0,.45)"; el.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--gris').trim() || '#344052'; } cuadroTimeouts.delete(id); },220);
        cuadroTimeouts.set(id,t);
      }

      // Playback with safe pausing/resuming
      function startSequencePlayback(fromIndex = 0){
        stopSequencePlayback();
        if(!Array.isArray(secuencia) || secuencia.length === 0) { jugantSequencia = false; return; }
        playIndex = Math.max(0, fromIndex);
        jugantSequencia = true;
        wasPlayingWhenPaused = true;
        iluminarCuadro(secuencia[playIndex]);
        playIndex++;
        seqInterval = setInterval(()=>{
          if(paused){ stopSequencePlayback(); return; }
          if(playIndex >= secuencia.length){
            stopSequencePlayback();
            jugantSequencia = false;
            wasPlayingWhenPaused = false;
            playIndex = 0;
            if(!paused){ jugador = []; esperandoInput = true; startInputTimer(); }
            return;
          }
          iluminarCuadro(secuencia[playIndex]);
          playIndex++;
        }, 550);
      }

      function stopSequencePlayback(){
        if(seqInterval){ clearInterval(seqInterval); seqInterval = null; }
      }

      function startInputTimer(){
        clearTimeout(inputTimer);
        inputTimer = setTimeout(()=>{ handleTimeoutLoss(); }, TIEMPO_MAX);
      }
      function stopInputTimer(){ clearTimeout(inputTimer); inputTimer = null; }

      function pauseEverything(){
        if(paused) return;
        paused = true;
        if(seqInterval){
          clearInterval(seqInterval);
          seqInterval = null;
          wasPlayingWhenPaused = true;
        } else {
          wasPlayingWhenPaused = false;
        }
        stopInputTimer();
      }

      function resumeEverything(){
        if(!paused) return;
        paused = false;
        if(wasPlayingWhenPaused){
          setTimeout(()=> startSequencePlayback(playIndex), 80);
        } else {
          if(!jugantSequencia && esperandoInput){
            startInputTimer();
          }
        }
        wasPlayingWhenPaused = false;
      }

      // Game logic
      function iniciarJoc(){
        secuencia = [];
        jugador = [];
        nivell = 1;
        nivellTexto.innerText = 'Nivell: ' + nivell;
        mensaje.innerText = '';
        esperandoInput = false;
        paused = false;
        stopSequencePlayback();
        stopInputTimer();
        playIndex = 0;
        wasPlayingWhenPaused = false;
        startOverlay.style.display = 'none';
        pauseOverlay.style.display = 'none';
        gameOverOverlay.style.display = 'none';
        secuencia.push(Math.floor(Math.random() * size));
        setTimeout(()=> startSequencePlayback(0), 160);
      }

      function addOneAndPlay(){
        jugador = [];
        esperandoInput = false;
        secuencia.push(Math.floor(Math.random() * size));
        setTimeout(()=> startSequencePlayback(0), 80);
      }

      function handleTimeoutLoss(){
        if(paused) return;
        esperandoInput = false;
        mensaje.innerText = "‚è±Ô∏è Has trigat massa...";
        setTimeout(()=>{ mensaje.innerText=''; showGameOver(); }, 700);
      }

      function showGameOver(){
        finalLevelEl.innerText = nivell;
        finalSeqInfo.innerText = 'Longitud de la seq√º√®ncia: ' + secuencia.length;
        gameOverOverlay.style.display = 'flex';
      }

      function onCuadroClick(e){
        if(paused) return;
        if(jugantSequencia || !esperandoInput) return;
        stopInputTimer();
        const el = e.currentTarget;
        const id = parseInt(el.getAttribute('data-id'));
        jugador.push(id);
        const idx = jugador.length - 1;
        if(secuencia[idx] !== id){
          clearCuadroTimeout(id);
          el.classList.add('wrong');
          el.style.backgroundColor = coloresFijos[id];
          el.style.boxShadow = "0 12px 34px rgba(0,0,0,.55), 0 0 20px " + hexToRgba(coloresFijos[id], .34);
          playTone(220,350,'sawtooth');
          mensaje.innerText = "‚ùå Has fallat...";
          esperandoInput = false;
          jugantSequencia = false;
          setTimeout(()=>{
            clearCuadroTimeout(id);
            el.classList.remove('wrong');
            el.style.boxShadow = "0 6px 18px rgba(0,0,0,.45)";
            el.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--gris').trim() || '#344052';
            mensaje.innerText = '';
            showGameOver();
          },700);
          return;
        }
        feedbackLocalCuadro(el,id);
        verifyProgress();
      }

      function verifyProgress(){
        if(jugador.length === secuencia.length){
          if(secuencia.length >= llindarDeNivell(nivell)){
            const prev = nivell;
            nivell++;
            nivellTexto.innerText = 'Nivell: ' + nivell;
            mensaje.innerText = "üîì Nivell " + prev + " completat! Comen√ßa Nivell " + nivell + ".";
            secuencia = [];
            jugador = [];
            esperandoInput = false;
            stopSequencePlayback();
            stopInputTimer();
            setTimeout(()=>{ mensaje.innerText=''; secuencia.push(Math.floor(Math.random()*size)); startSequencePlayback(0); },900);
            return;
          }
          mensaje.innerText = "‚úÖ B√©!";
          esperandoInput = false;
          stopInputTimer();
          setTimeout(()=>{ mensaje.innerText=''; secuencia.push(Math.floor(Math.random()*size)); startSequencePlayback(0); },700);
        } else {
          if(!paused) startInputTimer();
        }
      }

      // Pause/open/close handling
      function openPause(){
        if(startOverlay.style.display !== 'none' || gameOverOverlay.style.display === 'flex') return;
        if(pauseOverlay.style.display === 'flex') return;
        pauseEverything();
        pauseLevelText.innerText = 'Nivell ' + nivell;
        pauseOverlay.style.display = 'flex';
      }

      function closePause(){
        if(pauseOverlay.style.display !== 'flex') return;
        pauseOverlay.style.display = 'none';
        resumeEverything();
      }

      document.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape'){
          if(startOverlay.style.display !== 'none') return;
          if(gameOverOverlay.style.display === 'flex') return;
          if(pauseOverlay.style.display === 'flex') closePause(); else openPause();
        }
      });

      resumeBtn.addEventListener('click', closePause);
      restartSameBtn.addEventListener('click', ()=>{ pauseOverlay.style.display='none'; paused=false; iniciarJoc(); });
      toStartBtn.addEventListener('click', ()=>{ pauseOverlay.style.display='none'; paused=false; startOverlay.style.display='flex'; });

      // overlay interactions
      sizeOptions.forEach(opt=>{
        opt.addEventListener('click', ()=>{
          sizeOptions.forEach(o=>{ o.classList.remove('selected'); o.setAttribute('aria-checked','false'); });
          opt.classList.add('selected'); opt.setAttribute('aria-checked','true');
          size = parseInt(opt.getAttribute('data-size'));
        });
        opt.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); opt.click(); } });
      });
      startBtn.addEventListener('click', ()=>{ setupBoard(size); startOverlay.style.display='none'; iniciarJoc(); });

      retryBtn.addEventListener('click', ()=>{ gameOverOverlay.style.display='none'; startOverlay.style.display='flex'; });

      function setupBoard(n){
        size = n;
        if(size===4) cols=2; else if(size===9) cols=3; else cols=4;
        baseStep = (size===4?2: size===9?3:4);
        coloresFijos = generarColors(size);
        frecuencias = generarFrecuencias(size);
        cuadrosContainer.innerHTML = '';
        cuadrosContainer.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
        for(let i=0;i<size;i++){
          const d = document.createElement('div');
          d.className = 'cuadro';
          d.setAttribute('data-id', i);
          d.setAttribute('role','button');
          d.setAttribute('aria-label','Quadrat '+(i+1));
          d.tabIndex = 0;
          cuadrosContainer.appendChild(d);
        }
        attachListeners();
      }

      // init defaults
      setupBoard(9);
      startOverlay.style.display = 'flex';
      mensaje.innerText = 'Tria la mida i prem Comen√ßar';
    };
  </script>
</body>
</html>
