<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Salón de Ritmos i Melodia - correcció</title>
<style>
:root{--bg:#1e1f24;--panel:#2b2f39;--room:#2b2f39;--text:#eaeaea;--accent:#ffd45e;--off:#656a77;--on:#4bd17b;--line:#3a3f4a;--kick:#d96b6b;--snare:#5aa2e0;--hihat:#e0d96a;--clap:#b98adf;--piano:#f4c27a;--glock:#9ad0ff;--bass:#a8f7c6;--lead:#f7a8d9;--pad:#cdb4ff}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Arial,sans-serif}
.header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
.tabbar{display:flex;gap:8px;padding:8px 16px}
.tab{padding:8px 12px;border-radius:8px;background:var(--panel);border:1px solid var(--line);cursor:pointer}
.tab.active{box-shadow:inset 0 -2px 0 #00000033}
.container{padding:16px}
.room-wrap{background:var(--room);border-radius:12px;padding:12px;box-shadow:inset 0 0 0 1px var(--line);max-height:62vh;overflow:auto}
.controls-ui{display:flex;gap:8px;align-items:center}
.controls-ui button, .controls-ui input[type="range"], .controls-ui span{background:var(--panel);color:var(--text);border:1px solid var(--line);padding:8px 10px;border-radius:8px}
.ritme-top{display:flex;gap:12px;align-items:center;margin-bottom:8px}
.ritme-grid{display:grid;grid-template-columns:96px 1fr;gap:12px 12px;align-items:center}
.slot{width:64px;height:64px;border-radius:50%;border:2px dashed #7c8291;display:flex;align-items:center;justify-content:center}
.steps{display:grid;grid-template-columns:repeat(32,22px);gap:6px}
.step{width:22px;height:22px;border-radius:6px;background:var(--off);border:1px solid var(--line);cursor:pointer}
.step.active{background:var(--on)}
.step.current{outline:2px solid var(--accent)}
.piano-grid{display:grid;grid-auto-rows:32px;gap:6px}
.piano-row{display:grid;grid-template-columns:80px 1fr;gap:8px;align-items:center}
.note-steps{display:flex;gap:6px;align-items:center;justify-content:flex-start;overflow:auto;white-space:nowrap}
.note-cell{width:20px;height:28px;flex:0 0 20px;border-radius:4px;background:#2e3137;border:1px solid #3a3f4a;cursor:pointer}
.note-cell.active{background:var(--accent)}
.small-input{width:84px;padding:6px 8px;border-radius:8px;border:1px solid var(--line);background:var(--panel);color:var(--text)}
.legend{display:flex;gap:12px;align-items:center;margin-top:10px;color:#aeb4c2}
</style>
</head>
<body>
  <div class="header">
    <div style="font-size:18px">Salón de Ritmos i Melodia</div>
    <div class="controls-ui">
      <button id="startStop">Iniciar</button>
      <label>BPM <input id="bpm" type="range" min="50" max="200" value="100"/></label>
      <span id="bpmVal">100</span>
      <button id="clear">Netejar</button>
      <button id="save">Guardar</button>
      <button id="load">Carregar</button>
      <input id="fileInput" type="file" accept="application/json" style="display:none" />
    </div>
  </div>

  <div class="tabbar">
    <div class="tab active" data-tab="ritmo">Salón de Ritmos</div>
    <div class="tab" data-tab="melodia">Salón de Melodia</div>
  </div>

  <div class="container">
    <div id="ritmoView" class="room-wrap">
      <div class="ritme-top">
        <div id="palette" style="display:flex;gap:8px">
          <div class="instrument" draggable="true" data-sound="kick" style="background:var(--kick);padding:8px;border-radius:8px">Kick</div>
          <div class="instrument" draggable="true" data-sound="snare" style="background:var(--snare);padding:8px;border-radius:8px">Snare</div>
          <div class="instrument" draggable="true" data-sound="hihat" style="background:var(--hihat);padding:8px;border-radius:8px">HiHat</div>
          <div class="instrument" draggable="true" data-sound="clap" style="background:var(--clap);padding:8px;border-radius:8px">Clap</div>
        </div>
        <div style="margin-left:auto;color:#aeb4c2">Arrossega un instrument al cercle</div>
      </div>

      <div id="ritmeGrid" class="ritme-grid"></div>

      <div class="legend"><span><strong>Tip:</strong> doble clic al cercle per eliminar instrument</span></div>
    </div>

    <div id="melodiaView" class="room-wrap" style="display:none;margin-top:16px">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
        <div style="display:flex;gap:8px">
          <div class="mel-instr" data-inst="piano" style="background:var(--piano);padding:8px;border-radius:8px;cursor:pointer">Piano</div>
          <div class="mel-instr" data-inst="glock" style="background:var(--glock);padding:8px;border-radius:8px;cursor:pointer">Glock</div>
          <div class="mel-instr" data-inst="lead" style="background:var(--lead);padding:8px;border-radius:8px;cursor:pointer">Lead</div>
        </div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <label style="color:#aeb4c2">Vol Melodia <input id="melVol" type="range" min="0" max="200" value="100" style="margin-left:8px"/></label>
          <label style="color:#aeb4c2">Llargada <input id="melLen" class="small-input" type="number" min="1" max="1000" value="32" style="margin-left:8px"/></label>
        </div>
      </div>

      <div id="pianoGrid" class="piano-grid"></div>

      <div class="legend"><span style="color:#aeb4c2">Nota activa = groc</span></div>
    </div>
  </div>

<script>
/* --- minimal safe JS init i checks per evitar errors que trenquin la UI --- */
(function(){
  // WebAudio context (crea quan l'usuari prem "Iniciar")
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let audio = null;

  function ensureAudio(){
    if(!audio) audio = new AudioCtx();
    return audio;
  }

  // constants
  const STEPS = 32;
  const NOTES = [67,66,65,64,63,62,61,60];

  // elements
  const startStopBtn = document.getElementById('startStop');
  const bpmInput = document.getElementById('bpm');
  const bpmVal = document.getElementById('bpmVal');
  const ritmeGrid = document.getElementById('ritmeGrid');
  const palette = document.getElementById('palette');
  const melodiaView = document.getElementById('melodiaView');
  const ritmoView = document.getElementById('ritmoView');
  const pianoGrid = document.getElementById('pianoGrid');
  const melVol = document.getElementById('melVol');
  const melLenInput = document.getElementById('melLen');
  const fileInput = document.getElementById('fileInput');

  // simple state
  let bpm = 100; let isPlaying=false; let tickCounter=0; let timer=null;
  let rows = []; let noteRows = []; let melInstrument = 'piano';
  let melLen = 32;

  // utils safe
  function midiToNoteName(m){ const names=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B']; return names[m%12] + (Math.floor(m/12)-1); }

  // create ritme rows
  function makeRitmeRow(){
    const slot = document.createElement('div'); slot.className='slot'; slot.innerHTML='<div class="label">—</div>';
    const steps = document.createElement('div'); steps.className='steps';
    const pattern = new Array(STEPS).fill(false);
    const stepEls = [];
    for(let i=0;i<STEPS;i++){
      const c=document.createElement('div'); c.className='step'; c.dataset.index=i;
      c.addEventListener('click', ()=>{ pattern[i]=!pattern[i]; c.classList.toggle('active'); });
      steps.appendChild(c); stepEls.push(c);
    }
    const controlsWrap = document.createElement('div');
    ritmeGrid.appendChild(slot); ritmeGrid.appendChild(controlsWrap); ritmeGrid.appendChild(steps);

    // dnd handlers
    slot.addEventListener('dragover', e=>{ e.preventDefault(); slot.classList.add('drag-over'); });
    slot.addEventListener('dragleave', ()=> slot.classList.remove('drag-over'));
    slot.addEventListener('drop', e=>{ e.preventDefault(); slot.classList.remove('drag-over'); const sound = e.dataTransfer.getData('application/x-sound') || e.dataTransfer.getData('text/plain'); if(sound){ row.sound = sound; slot.querySelector('.label').textContent = sound; slot.classList.add(sound); } });
    slot.addEventListener('dblclick', ()=>{ row.sound=null; slot.querySelector('.label').textContent='—'; slot.className='slot'; });

    const row = { slotEl: slot, stepEls, pattern, sound:null, gainVal:1 };
    return row;
  }

  // build initial ritme UI (8 rows)
  function buildRitme(){
    ritmeGrid.innerHTML='';
    rows = [];
    for(let i=0;i<8;i++){
      const r = makeRitmeRow();
      rows.push(r);
      if(i<7){ const d=document.createElement('div'); d.className='grid-row-divider'; ritmeGrid.appendChild(d); }
    }
  }

  // build melody grid (flex rows) with melLen columns
  function buildMelody(){
    pianoGrid.innerHTML=''; noteRows = [];
    for(const n of NOTES){
      const rowWrap = document.createElement('div'); rowWrap.className='piano-row';
      const label = document.createElement('div'); label.className='note-label'; label.textContent = midiToNoteName(n);
      const steps = document.createElement('div'); steps.className='note-steps';
      rowWrap.appendChild(label); rowWrap.appendChild(steps); pianoGrid.appendChild(rowWrap);
      const pattern = new Array(melLen).fill(false);
      const cells = [];
      for(let i=0;i<melLen;i++){
        const c = document.createElement('div'); c.className='note-cell'; c.dataset.index = i;
        c.addEventListener('click', ()=>{ pattern[i]=!pattern[i]; c.classList.toggle('active'); });
        steps.appendChild(c); cells.push(c);
      }
      noteRows.push({note:n,pattern,cells});
    }
  }

  // simple scheduler visual only (no audio in this minimal fix to avoid audio exceptions)
  function scheduleTick(){
    const rhythmIndex = tickCounter % STEPS;
    const melodyIndex = tickCounter % Math.max(1, melLen);
    // rhythm visuals
    rows.forEach(row => row.stepEls.forEach((el,i)=> el.classList.toggle('current', i === rhythmIndex)));
    // melody visuals
    noteRows.forEach(r => r.cells.forEach((el,i)=> el.classList.toggle('current', i === melodyIndex)));
    tickCounter++; timer = setTimeout(scheduleTick, (60/bpm)/4 * 1000);
  }

  // tabs
  document.querySelectorAll('.tab').forEach(t=>{
    t.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      if(t.dataset.tab === 'ritmo'){ ritmoView.style.display=''; melodiaView.style.display='none'; }
      else { ritmoView.style.display='none'; melodiaView.style.display=''; }
    });
  });

  // palette DnD
  palette.querySelectorAll('.instrument').forEach(el=>{
    el.addEventListener('dragstart', e=>{
      e.dataTransfer.setData('application/x-sound', el.dataset.sound);
      e.dataTransfer.setData('text/plain', el.dataset.sound);
    });
  });

  // controls
  bpmInput.addEventListener('input', ()=>{ bpm = parseInt(bpmInput.value,10); bpmVal.textContent = bpm; });
  startStopBtn.addEventListener('click', ()=>{
    if(!isPlaying){ isPlaying=true; startStopBtn.textContent='Parar'; scheduleTick(); } else { isPlaying=false; startStopBtn.textContent='Iniciar'; clearTimeout(timer); timer=null; }
  });
  melLenInput.addEventListener('input', ()=>{ let v = parseInt(melLenInput.value,10)||1; if(v<1) v=1; if(v>1000) v=1000; melLen=v; melLenInput.value=v; buildMelody(); });

  // save/load (simple)
  document.getElementById('save').addEventListener('click', ()=>{
    const payload = { bpm, rhythm: rows.map(r=>({sound:r.sound,pattern:r.pattern})), melody:{melLen, notes: noteRows.map(r=>r.pattern)} };
    const blob = new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='pattern.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });
  document.getElementById('load').addEventListener('click', ()=> fileInput.click());
  fileInput.addEventListener('change', async ()=>{
    const f = fileInput.files[0]; if(!f) return;
    try{ const text = await f.text(); const obj = JSON.parse(text);
      if(typeof obj.bpm === 'number'){ bpm = obj.bpm; bpmInput.value=bpm; bpmVal.textContent=bpm; }
      if(Array.isArray(obj.rhythm)){ obj.rhythm.slice(0, rows.length).forEach((st,i)=>{ rows[i].pattern = st.pattern.slice(0,STEPS); rows[i].stepEls.forEach((el,j)=> el.classList.toggle('active', !!rows[i].pattern[j])); rows[i].sound = st.sound || null; if(rows[i].sound) rows[i].slotEl.querySelector('.label').textContent = rows[i].sound; }); }
      if(obj.melody && typeof obj.melody.melLen === 'number'){ melLen = Math.max(1, Math.min(1000, Math.floor(obj.melody.melLen))); melLenInput.value = melLen; buildMelody(); if(Array.isArray(obj.melody.notes)){ obj.melody.notes.slice(0,noteRows.length).forEach((p,ri)=>{ const row = noteRows[ri]; for(let j=0;j<Math.min(p.length,row.pattern.length); j++){ row.pattern[j] = !!p[j]; if(row.pattern[j]) row.cells[j].classList.add('active'); } }); } }
      alert('Carregat.');
    }catch(e){ alert('Error al carregar'); }
    finally{ fileInput.value=''; }
  });

  // initial build
  buildRitme();
  buildMelody();

  // expose for debugging (opcional)
  window._app = { rows, noteRows, buildRitme, buildMelody };

})();
</script>
</body>
</html>
