<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Salón de Ritmos — drag & drop amb guardar/cargar</title>
  <style>
    :root {
      --bg:#1e1f24; --panel:#2b2f39; --room:#2b2f39; --text:#eaeaea;
      --accent:#ffd45e; --off:#656a77; --on:#4bd17b; --line:#3a3f4a;
    }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--text); font-family:system-ui, Arial, sans-serif; }
    header { padding:16px 20px; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px; }
    header h1 { margin:0; font-size:20px; }
    #controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    #controls button, #controls input {
      background:var(--panel); color:var(--text); border:1px solid var(--line);
      padding:8px 12px; border-radius:8px;
    }
    #controls input[type="range"] { width:160px; }

    /* Paleta draggable */
    #palette { display:flex; gap:12px; align-items:center; padding:12px 20px; margin:0 20px 12px; }
    .instrument {
      display:flex; align-items:center; justify-content:center;
      width:84px; height:64px; border-radius:10px; user-select:none; cursor:grab;
      border:1px solid var(--line); background:var(--panel); font-weight:600;
    }
    .instrument[data-sound="kick"]  { background:#d96b6b; }
    .instrument[data-sound="snare"] { background:#5aa2e0; }
    .instrument[data-sound="hihat"] { background:#e0d96a; color:#111; }
    .instrument[data-sound="clap"]  { background:#b98adf; }

    /* Sala / graella */
    #room {
      background:var(--room); margin:0 20px 20px; border-radius:12px;
      box-shadow:inset 0 0 0 1px var(--line); padding:16px;
    }
    .grid {
      display:grid;
      grid-template-columns: 80px 1fr; /* cercle + passos */
      gap:14px 16px; align-items:center;
    }
    .row { display:contents; }

    /* Slot (drop target) */
    .slot {
      width:60px; height:60px; border-radius:50%;
      border:2px dashed #7c8291; background:transparent;
      display:flex; align-items:center; justify-content:center;
      color:#aeb4c2; font-size:12px; user-select:none;
      transition:border-color 120ms ease, box-shadow 120ms ease;
    }
    .slot.filled { border-style:solid; border-color:#aeb4c2; color:#eaeaea; }
    .slot.drag-over { border-color:var(--accent); box-shadow:0 0 0 3px #ffd45e55; }
    .slot .label { font-weight:600; font-size:12px; text-align:center; line-height:1.1; pointer-events:none; }

    /* 32 passos */
    .steps {
      display:grid;
      grid-template-columns: repeat(32, 22px);
      gap:6px; align-items:center;
    }
    .step {
      width:22px; height:22px; border-radius:6px;
      background:var(--off); cursor:pointer; border:1px solid var(--line);
      transition:transform 80ms ease, background 120ms ease;
    }
    .step:hover { transform:scale(1.06); }
    .step.active { background:var(--on); }
    .step.current { outline:2px solid var(--accent); }

    .grid-row-divider {
      grid-column: 1 / -1; height:1px; background:var(--line); opacity:0.5; margin:8px 0;
    }

    #legend { display:flex; gap:12px; align-items:center; color:#aeb4c2; font-size:12px; padding:0 20px 16px; }
    #legend span { display:inline-flex; align-items:center; gap:6px; }
    .dot { width:10px; height:10px; border-radius:50%; display:inline-block; }

    /* Feedback arrossegant */
    .instrument.dragging { opacity:0.85; }
  </style>
</head>
<body>
  <header>
    <h1>Salón de Ritmos — drag & drop</h1>
    <div id="controls">
      <button id="startStop">Iniciar</button>
      <label>BPM <input id="bpm" type="range" min="50" max="200" value="100"/></label>
      <span id="bpmVal">100</span>
      <button id="clear">Limpiar salón</button>
      <button id="save">Guardar patrón</button>
      <button id="load">Cargar patrón</button>
    </div>
  </header>

  <div id="palette" aria-label="Paleta d'instruments">
    <div class="instrument" draggable="true" data-sound="kick">Kick</div>
    <div class="instrument" draggable="true" data-sound="snare">Snare</div>
    <div class="instrument" draggable="true" data-sound="hihat">HiHat</div>
    <div class="instrument" draggable="true" data-sound="clap">Clap</div>
  </div>

  <div id="room" aria-label="Salón">
    <div class="grid" id="grid"></div>
  </div>

  <div id="legend">
    <span><span class="dot" style="background:var(--on)"></span>Activo</span>
    <span><span class="dot" style="background:var(--off)"></span>Inactivo</span>
    <span><span class="dot" style="background:var(--accent)"></span>Paso actual</span>
  </div>

  <script>
    // Audio
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    const audio = new AudioCtx();

    function playKick(time, gainMul=1) {
      const osc = audio.createOscillator();
      const gain = audio.createGain();
      osc.type = "sine";
      osc.frequency.setValueAtTime(150, time);
      osc.frequency.exponentialRampToValueAtTime(50, time + 0.12);
      gain.gain.setValueAtTime(1 * gainMul, time);
      gain.gain.exponentialRampToValueAtTime(0.001, time + 0.22);
      osc.connect(gain).connect(audio.destination);
      osc.start(time); osc.stop(time + 0.24);
    }
    function playSnare(time, gainMul=1) {
      const noiseBuf = audio.createBuffer(1, audio.sampleRate * 0.2, audio.sampleRate);
      const data = noiseBuf.getChannelData(0);
      for (let i=0;i<data.length;i++) data[i] = (Math.random()*2-1) * 0.6;
      const noise = audio.createBufferSource(); noise.buffer = noiseBuf;
      const bandpass = audio.createBiquadFilter(); bandpass.type = "bandpass"; bandpass.frequency.value = 1800;
      const gain = audio.createGain();
      gain.gain.setValueAtTime(0.8 * gainMul, time);
      gain.gain.exponentialRampToValueAtTime(0.001, time + 0.18);
      noise.connect(bandpass).connect(gain).connect(audio.destination);
      noise.start(time); noise.stop(time + 0.2);
    }
    function playHiHat(time, gainMul=1) {
      const noiseBuf = audio.createBuffer(1, audio.sampleRate * 0.08, audio.sampleRate);
      const data = noiseBuf.getChannelData(0);
      for (let i=0;i<data.length;i++) data[i] = (Math.random()*2-1) * 0.4;
      const noise = audio.createBufferSource(); noise.buffer = noiseBuf;
      const highpass = audio.createBiquadFilter(); highpass.type = "highpass"; highpass.frequency.value = 6000;
      const gain = audio.createGain();
      gain.gain.setValueAtTime(0.5 * gainMul, time);
      gain.gain.exponentialRampToValueAtTime(0.001, time + 0.08);
      noise.connect(highpass).connect(gain).connect(audio.destination);
      noise.start(time); noise.stop(time + 0.1);
    }
    function playClap(time, gainMul=1) {
      const burst = (t, amp) => {
        const noiseBuf = audio.createBuffer(1, audio.sampleRate * 0.06, audio.sampleRate);
        const d = noiseBuf.getChannelData(0);
        for (let i=0;i<d.length;i++) d[i] = (Math.random()*2-1) * 0.5;
        const src = audio.createBufferSource(); src.buffer = noiseBuf;
        const gain = audio.createGain(); gain.gain.setValueAtTime(amp * gainMul, t);
        gain.gain.exponentialRampToValueAtTime(0.001, t + 0.07);
        src.connect(gain).connect(audio.destination);
        src.start(t); src.stop(t + 0.08);
      };
      burst(time, 0.6); burst(time+0.02, 0.5); burst(time+0.04, 0.4);
    }
    const synthByName = { kick: playKick, snare: playSnare, hihat: playHiHat, clap: playClap };

    // Estat
    const STEPS = 32;
    let bpm = 100;
    let isPlaying = false;
    let schedulerTimer = null;
    let currentStep = 0;

    const bpmInput = document.getElementById("bpm");
    const bpmVal = document.getElementById("bpmVal");
    bpmInput.addEventListener("input", () => { bpm = parseInt(bpmInput.value,10); bpmVal.textContent = bpm; });

    const startStopBtn = document.getElementById("startStop");
    startStopBtn.addEventListener("click", async () => {
      if (!isPlaying) {
        await audio.resume();
        isPlaying = true; startStopBtn.textContent = "Parar";
        scheduleTick();
      } else {
        isPlaying = false; startStopBtn.textContent = "Iniciar";
        clearTimeout(schedulerTimer); schedulerTimer = null;
        document.querySelectorAll(".step").forEach(s => s.classList.remove("current"));
        currentStep = 0;
      }
    });

    // Paleta drag & drop
    let draggedSound = null;
    document.querySelectorAll('.instrument').forEach(el => {
      el.addEventListener('dragstart', e => {
        draggedSound = el.dataset.sound;
        e.dataTransfer.effectAllowed = 'copy';
        e.dataTransfer.setData('application/x-sound', draggedSound);
        e.dataTransfer.setData('text/plain', draggedSound); // fallback
        el.classList.add('dragging');
      });
      el.addEventListener('dragend', () => {
        draggedSound = null;
        el.classList.remove('dragging');
      });
    });

    // Graella i files
    const grid = document.getElementById("grid");
    const rows = []; // [{ slotEl, pattern:Array<bool>, stepEls:[], sound:string|null }, ...]

    const instrumentNames = { kick: "Kick", snare: "Snare", hihat: "HiHat", clap: "Clap" };

    function attachSlotDnD(slot, row) {
      const getSoundFromEvent = (e) =>
        e.dataTransfer.getData('application/x-sound') ||
        e.dataTransfer.getData('text/plain') ||
        draggedSound;

      slot.addEventListener('dragenter', e => {
        e.preventDefault(); e.stopPropagation();
        slot.classList.add('drag-over');
      });
      slot.addEventListener('dragover', e => {
        e.preventDefault(); e.stopPropagation();
        e.dataTransfer.dropEffect = 'copy';
        slot.classList.add('drag-over');
      });
      slot.addEventListener('dragleave', e => {
        e.stopPropagation();
        slot.classList.remove('drag-over');
      });
      slot.addEventListener('drop', e => {
        e.preventDefault(); e.stopPropagation();
        const targetSlot = e.target.closest('.slot');
        if (!targetSlot) return;
        slot.classList.remove('drag-over');
        const sound = getSoundFromEvent(e);
        if (!sound) return;
        row.sound = sound;
        slot.classList.add("filled");
        slot.querySelector('.label').textContent = instrumentNames[sound];
      });

      // Doble clic: buidar
      slot.addEventListener("dblclick", () => {
        row.sound = null;
        slot.classList.remove("filled");
        slot.querySelector('.label').textContent = "—";
      });
    }

    function makeRow() {
      const slot = document.createElement("div");
      slot.className = "slot";
      slot.innerHTML = '<div class="label">—</div>';

      const steps = document.createElement("div");
      steps.className = "steps";
      const pattern = new Array(STEPS).fill(false);
      const stepEls = [];
      for (let i=0; i<STEPS; i++) {
        const cell = document.createElement("div");
        cell.className = "step";
        cell.dataset.index = i;
        cell.addEventListener("click", () => {
          pattern[i] = !pattern[i];
          cell.classList.toggle("active");
        });
        steps.appendChild(cell);
        stepEls.push(cell);
      }

      const row = { slotEl: slot, pattern, stepEls, sound: null };
      attachSlotDnD(slot, row);

      grid.appendChild(slot);
      grid.appendChild(steps);
      return row;
    }

    for (let r=0; r<4; r++) {
      const row = makeRow();
      rows.push(row);
      if (r < 3) {
        const divider = document.createElement("div");
        divider.className = "grid-row-divider";
        grid.appendChild(divider);
      }
    }

    // Scheduler
    function scheduleTick() {
      const spb = 60 / bpm;
      const stepDur = spb / 4; // semicorxeres: 32 passos / compàs 4/4
      const now = audio.currentTime;

      rows.forEach(row => {
        row.stepEls.forEach((el,i) => el.classList.toggle("current", i === currentStep));
        if (row.sound && row.pattern[currentStep]) {
          const fn = synthByName[row.sound];
          if (fn) fn(now + 0.02, 1);
        }
      });

      currentStep = (currentStep + 1) % STEPS;
      schedulerTimer = setTimeout(scheduleTick, stepDur * 1000);
    }

    // --------- Net, guardar i carregar ---------

    function serializeRows() {
      return rows.map(row => ({
        sound: row.sound || null,
        pattern: row.pattern.slice(), // còpia
      }));
    }

    function applyRowsState(state) {
      // Net visual
      rows.forEach(row => {
        row.sound = null;
        row.slotEl.classList.remove('filled');
        row.slotEl.querySelector('.label').textContent = '—';
        row.pattern.fill(false);
        row.stepEls.forEach(el => el.classList.remove('active', 'current'));
      });

      // Aplica estat
      state.slice(0, rows.length).forEach((st, idx) => {
        const row = rows[idx];
        if (st.sound) {
          row.sound = st.sound;
          row.slotEl.classList.add('filled');
          row.slotEl.querySelector('.label').textContent = instrumentNames[st.sound] || st.sound;
        }
        st.pattern?.forEach((on, i) => {
          row.pattern[i] = !!on;
          row.stepEls[i].classList.toggle('active', !!on);
        });
      });
    }

    // Botó Limpiar salón
    document.getElementById('clear').addEventListener('click', () => {
      applyRowsState(rows.map(() => ({ sound:null, pattern:new Array(STEPS).fill(false) })));
    });

    // Botó Guardar patrón
    document.getElementById('save').addEventListener('click', () => {
      const payload = { steps: STEPS, rows: serializeRows(), bpm };
      localStorage.setItem('salonRitmos_v2', JSON.stringify(payload));
      alert('Patrón guardado.');
    });

    // Botó Cargar patrón
    document.getElementById('load').addEventListener('click', () => {
      const raw = localStorage.getItem('salonRitmos_v2');
      if (!raw) return alert('No hay patrón guardado.');
      try {
        const payload = JSON.parse(raw);
        if (!payload || !Array.isArray(payload.rows)) throw new Error('Formato inválido');
        // Ajust si el guardat té diferent nombre de passos
        if (payload.steps && payload.steps !== STEPS) {
          // Si tens 16 o 64, fem adaptació senzilla (truncate o pad)
          payload.rows.forEach(r => {
            const arr = new Array(STEPS).fill(false);
            for (let i=0; i<Math.min(STEPS, r.pattern.length); i++) arr[i] = !!r.pattern[i];
            r.pattern = arr;
          });
        }
        applyRowsState(payload.rows);
        if (typeof payload.bpm === 'number') {
          bpm = payload.bpm;
          bpmInput.value = bpm;
          bpmVal.textContent = bpm;
        }
        alert('Patrón cargado.');
      } catch(e) {
        alert('Error al cargar patrón.');
      }
    });
  </script>
</body>
</html>
