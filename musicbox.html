<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Salón de Ritmos — autoscroll mentre arrossegues</title>
  <style>
    :root{
      --bg:#1e1f24; --panel:#2b2f39; --room:#2b2f39; --text:#eaeaea;
      --accent:#ffd45e; --off:#656a77; --on:#4bd17b; --line:#3a3f4a;
      --kick:#d96b6b; --snare:#5aa2e0; --hihat:#e0d96a; --clap:#b98adf;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Arial,sans-serif}
    header{padding:16px 20px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px}
    header h1{margin:0;font-size:18px}
    #controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    #controls button,#controls input{background:var(--panel);color:var(--text);border:1px solid var(--line);padding:8px 10px;border-radius:8px}
    #controls input[type="range"]{width:140px}
    #palette{display:flex;gap:12px;align-items:center;padding:12px 20px;margin:0 20px 12px}
    .instrument{display:flex;align-items:center;justify-content:center;width:84px;height:56px;border-radius:10px;user-select:none;cursor:grab;border:1px solid var(--line);font-weight:700}
    .instrument[data-sound="kick"]{background:var(--kick)}
    .instrument[data-sound="snare"]{background:var(--snare)}
    .instrument[data-sound="hihat"]{background:var(--hihat);color:#111}
    .instrument[data-sound="clap"]{background:var(--clap)}
    #room{background:var(--room);margin:0 20px 20px;border-radius:12px;padding:16px;box-shadow:inset 0 0 0 1px var(--line); max-height:60vh; overflow:auto}
    .grid{display:grid;grid-template-columns:96px 1fr;gap:14px 16px;align-items:center; padding-bottom:12px}
    .slot{width:64px;height:64px;border-radius:50%;border:2px dashed #7c8291;background:transparent;display:flex;align-items:center;justify-content:center;color:#aeb4c2;font-size:12px;user-select:none;transition:border-color 120ms,box-shadow 120ms,background 160ms}
    .slot .label{pointer-events:none;font-weight:700;text-align:center}
    .slot.filled{color:#111}
    .slot.drag-over{border-color:var(--accent);box-shadow:0 0 0 6px #ffd45e33}
    .slot.kick{border-color:var(--kick)}
    .slot.snare{border-color:var(--snare)}
    .slot.hihat{border-color:var(--hihat)}
    .slot.clap{border-color:var(--clap)}
    .steps{display:grid;grid-template-columns:repeat(32,22px);gap:6px;align-items:center}
    .step{width:22px;height:22px;border-radius:6px;background:var(--off);cursor:pointer;border:1px solid var(--line);transition:transform 80ms,background 120ms}
    .step:hover{transform:scale(1.06)}
    .step.active{background:var(--on)}
    .step.current{outline:2px solid var(--accent)}
    .grid-row-divider{grid-column:1/-1;height:1px;background:var(--line);opacity:.45;margin:8px 0}
    .controls-row{display:flex;flex-direction:column;gap:6px;align-items:flex-start}
    .vol-wrap{display:flex;align-items:center;gap:8px}
    .vol-wrap input[type="range"]{width:96px}
    #legend{display:flex;gap:12px;align-items:center;color:#aeb4c2;font-size:12px;padding:0 20px 12px}
    .dot{width:10px;height:10px;border-radius:50%;display:inline-block}
    .instrument.dragging{opacity:.8}
    @media (max-width:720px){ .grid{grid-template-columns:76px 1fr} .instrument{width:72px;height:48px} .slot{width:56px;height:56px} }
  </style>
</head>
<body>
  <header>
    <h1>Salón de Ritmos — autoscroll</h1>
    <div id="controls">
      <button id="startStop">Iniciar</button>
      <label>BPM <input id="bpm" type="range" min="50" max="200" value="100"/></label>
      <span id="bpmVal">100</span>
      <button id="clear">Limpiar salón</button>
      <button id="save">Guardar patrón</button>
      <button id="load">Cargar patrón</button>
      <input id="fileInput" type="file" accept="application/json" style="display:none" />
    </div>
  </header>

  <div id="palette" aria-label="Paleta d'instruments">
    <div class="instrument" draggable="true" data-sound="kick">Kick</div>
    <div class="instrument" draggable="true" data-sound="snare">Snare</div>
    <div class="instrument" draggable="true" data-sound="hihat">HiHat</div>
    <div class="instrument" draggable="true" data-sound="clap">Clap</div>
  </div>

  <div id="room" aria-label="Salón">
    <div class="grid" id="grid"></div>
  </div>

  <div id="legend">
    <span><span class="dot" style="background:var(--on)"></span>Activo</span>
    <span><span class="dot" style="background:var(--off)"></span>Inactivo</span>
    <span><span class="dot" style="background:var(--accent)"></span>Paso actual</span>
  </div>

  <script>
    // WebAudio i síntesi
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    const audio = new AudioCtx();
    function makeGain(g=1){ const n=audio.createGain(); n.gain.value=g; n.connect(audio.destination); return n; }

    function playKick(time, gainNode){ const osc=audio.createOscillator(); const g=audio.createGain(); osc.type='sine'; osc.frequency.setValueAtTime(150,time); osc.frequency.exponentialRampToValueAtTime(50,time+0.12); g.gain.setValueAtTime(1,time); g.gain.exponentialRampToValueAtTime(0.001,time+0.22); osc.connect(g).connect(gainNode); osc.start(time); osc.stop(time+0.24); }
    function playSnare(time, gainNode){ const buf=audio.createBuffer(1,audio.sampleRate*0.2,audio.sampleRate); const d=buf.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*0.6; const src=audio.createBufferSource(); src.buffer=buf; const band=audio.createBiquadFilter(); band.type='bandpass'; band.frequency.value=1800; const g=audio.createGain(); g.gain.setValueAtTime(0.8,time); g.gain.exponentialRampToValueAtTime(0.001,time+0.18); src.connect(band).connect(g).connect(gainNode); src.start(time); src.stop(time+0.2); }
    function playHiHat(time, gainNode){ const buf=audio.createBuffer(1,audio.sampleRate*0.08,audio.sampleRate); const d=buf.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*0.4; const src=audio.createBufferSource(); src.buffer=buf; const hp=audio.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=6000; const g=audio.createGain(); g.gain.setValueAtTime(0.5,time); g.gain.exponentialRampToValueAtTime(0.001,time+0.08); src.connect(hp).connect(g).connect(gainNode); src.start(time); src.stop(time+0.1); }
    function playClap(time, gainNode){ const burst=(t,a)=>{ const buf=audio.createBuffer(1,audio.sampleRate*0.06,audio.sampleRate); const d=buf.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*0.5; const s=audio.createBufferSource(); s.buffer=buf; const g=audio.createGain(); g.gain.setValueAtTime(a,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.07); s.connect(g).connect(gainNode); s.start(t); s.stop(t+0.08); }; burst(time,0.6); burst(time+0.02,0.5); burst(time+0.04,0.4); }
    const synthByName = { kick: playKick, snare: playSnare, hihat: playHiHat, clap: playClap };

    // Estat global
    const STEPS = 32;
    let bpm = 100, isPlaying = false, schedulerTimer = null, currentStep = 0;
    const bpmInput = document.getElementById('bpm'), bpmVal = document.getElementById('bpmVal');
    bpmInput.addEventListener('input', ()=>{ bpm = parseInt(bpmInput.value,10); bpmVal.textContent = bpm; });

    const startStopBtn = document.getElementById('startStop');
    startStopBtn.addEventListener('click', async ()=>{ if(!isPlaying){ await audio.resume(); isPlaying=true; startStopBtn.textContent='Parar'; scheduleTick(); } else{ isPlaying=false; startStopBtn.textContent='Iniciar'; clearTimeout(schedulerTimer); schedulerTimer=null; document.querySelectorAll('.step').forEach(s=>s.classList.remove('current')); currentStep=0; } });

    // Paleta DnD
    let draggedSound = null;
    let isDraggingInstrument = false;
    document.querySelectorAll('.instrument').forEach(el=>{
      el.addEventListener('dragstart', e=>{
        draggedSound = el.dataset.sound;
        isDraggingInstrument = true;
        e.dataTransfer.effectAllowed='copy';
        e.dataTransfer.setData('application/x-sound', draggedSound);
        e.dataTransfer.setData('text/plain', draggedSound);
        el.classList.add('dragging');
        // activar listeners globals per a autoscroll i wheel
        activateAutoScrollAndWheel();
      });
      el.addEventListener('dragend', ()=>{
        draggedSound = null;
        isDraggingInstrument = false;
        el.classList.remove('dragging');
        deactivateAutoScrollAndWheel();
      });
    });

    // Graella i files
    const grid = document.getElementById('grid');
    const room = document.getElementById('room');
    const rows = []; // {slotEl, controlsEl, stepEls, pattern, sound, gainNode, gainVal, volEl}
    const instrumentNames = { kick:'Kick', snare:'Snare', hihat:'HiHat', clap:'Clap' };
    const instrumentColorClass = { kick:'kick', snare:'snare', hihat:'hihat', clap:'clap' };

    function attachSlotDnD(slot, row){
      const getSound=(e)=> e.dataTransfer.getData('application/x-sound')||e.dataTransfer.getData('text/plain')||draggedSound;
      slot.addEventListener('dragenter', e=>{ e.preventDefault(); e.stopPropagation(); slot.classList.add('drag-over'); });
      slot.addEventListener('dragover', e=>{ e.preventDefault(); e.stopPropagation(); e.dataTransfer.dropEffect='copy'; slot.classList.add('drag-over'); });
      slot.addEventListener('dragleave', e=>{ e.stopPropagation(); slot.classList.remove('drag-over'); });
      slot.addEventListener('drop', e=>{ e.preventDefault(); e.stopPropagation(); slot.classList.remove('drag-over'); const target = e.target.closest('.slot'); if(!target) return; const sound = getSound(e); if(!sound) return; row.sound = sound; Object.values(instrumentColorClass).forEach(c=>row.slotEl.classList.remove(c)); row.slotEl.classList.add(instrumentColorClass[sound]); row.slotEl.classList.add('filled'); row.slotEl.querySelector('.label').textContent = instrumentNames[sound]; });
      slot.addEventListener('dblclick', ()=>{ row.sound = null; Object.values(instrumentColorClass).forEach(c=>row.slotEl.classList.remove(c)); row.slotEl.classList.remove('filled'); row.slotEl.querySelector('.label').textContent = '—'; });
    }

    function makeRow(){
      const slot = document.createElement('div'); slot.className='slot'; slot.innerHTML='<div class="label">—</div>';
      const steps = document.createElement('div'); steps.className='steps';
      const pattern = new Array(STEPS).fill(false); const stepEls = [];
      for(let i=0;i<STEPS;i++){ const cell=document.createElement('div'); cell.className='step'; cell.dataset.index=i; cell.addEventListener('click', ()=>{ pattern[i]=!pattern[i]; cell.classList.toggle('active'); }); steps.appendChild(cell); stepEls.push(cell); }

      const controlsWrap = document.createElement('div'); controlsWrap.className='controls-row';
      const volWrap = document.createElement('div'); volWrap.className='vol-wrap';
      const volLabel = document.createElement('span'); volLabel.textContent='Vol'; volLabel.style.color='#aeb4c2'; volLabel.style.fontSize='12px';
      const volIn = document.createElement('input'); volIn.type='range'; volIn.min='0'; volIn.max='200'; volIn.value='100';
      const row = { slotEl: slot, controlsEl: controlsWrap, stepEls, pattern, sound:null, gainNode: makeGain(1), gainVal:1, volEl: volIn };
      volIn.addEventListener('input', ()=>{ row.gainVal = parseInt(volIn.value,10)/100; if(row.gainNode) row.gainNode.gain.setValueAtTime(row.gainVal, audio.currentTime); });
      volWrap.appendChild(volLabel); volWrap.appendChild(volIn); controlsWrap.appendChild(volWrap);

      grid.appendChild(slot); grid.appendChild(controlsWrap); grid.appendChild(steps);
      attachSlotDnD(slot, row);
      return row;
    }

    // Crear 8 files inicials
    function createInitialRows(n=8){ for(let i=0;i<n;i++){ const row=makeRow(); rows.push(row); if(i < n-1){ const d=document.createElement('div'); d.className='grid-row-divider'; grid.appendChild(d); } } }
    createInitialRows(8);

    // Scheduler
    function scheduleTick(){ const spb = 60 / bpm; const stepDur = spb / 4; const now = audio.currentTime;
      rows.forEach(row=>{ row.stepEls.forEach((el,i)=> el.classList.toggle('current', i===currentStep)); if(row.sound && row.pattern[currentStep]){ const fn = synthByName[row.sound]; if(fn) fn(now+0.02, row.gainNode); } });
      currentStep = (currentStep + 1) % STEPS;
      schedulerTimer = setTimeout(scheduleTick, stepDur * 1000);
    }

    // Serialize / apply state
    function serializeRows(){ return rows.map(r => ({ sound: r.sound || null, pattern: r.pattern.slice(), vol: r.gainVal ?? 1 })); }
    function applyRowsState(state){
      rows.forEach(row=>{ row.sound=null; Object.values(instrumentColorClass).forEach(c=>row.slotEl.classList.remove(c)); row.slotEl.classList.remove('filled'); row.slotEl.querySelector('.label').textContent='—'; row.pattern.fill(false); row.stepEls.forEach(el=>el.classList.remove('active','current')); row.gainVal=1; row.gainNode.gain.setValueAtTime(1,audio.currentTime); row.volEl.value=100; });
      state.slice(0, rows.length).forEach((st, idx)=>{ const row = rows[idx]; if(st.sound){ row.sound = st.sound; row.slotEl.classList.add(instrumentColorClass[st.sound]); row.slotEl.classList.add('filled'); row.slotEl.querySelector('.label').textContent = instrumentNames[st.sound] || st.sound; } if(Array.isArray(st.pattern)){ st.pattern.forEach((p,i)=>{ row.pattern[i] = !!p; row.stepEls[i].classList.toggle('active', !!p); }); } if(typeof st.vol === 'number'){ row.gainVal = st.vol; row.gainNode.gain.setValueAtTime(row.gainVal,audio.currentTime); row.volEl.value = Math.round(row.gainVal*100); } });
    }

    // Clear / Save / Load
    document.getElementById('clear').addEventListener('click', ()=> applyRowsState(rows.map(()=>({ sound:null, pattern:new Array(STEPS).fill(false), vol:1 }))));

    document.getElementById('save').addEventListener('click', ()=>{
      const payload = { version:2, steps:STEPS, bpm, rows: serializeRows() };
      const blob = new Blob([JSON.stringify(payload,null,2)], { type:'application/json' });
      const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href = url; a.download = `salon_ritmos_${new Date().toISOString().replace(/[:.]/g,'-')}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    const fileInput = document.getElementById('fileInput');
    document.getElementById('load').addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', async ()=>{
      const f = fileInput.files[0]; if(!f) return;
      try{ const text = await f.text(); const payload = JSON.parse(text); if(!payload || !Array.isArray(payload.rows)) throw new Error('Formato inválido');
        if(payload.steps && payload.steps !== STEPS){ payload.rows.forEach(r=>{ const arr = new Array(STEPS).fill(false); for(let i=0;i<Math.min(STEPS, r.pattern.length); i++) arr[i]=!!r.pattern[i]; r.pattern = arr; }); }
        applyRowsState(payload.rows);
        if(typeof payload.bpm === 'number'){ bpm = payload.bpm; bpmInput.value = bpm; bpmVal.textContent = bpm; }
        alert('Patró carregat.');
      }catch(e){ alert('Error en carregar el JSON.'); } finally{ fileInput.value = ''; }
    });

    // ------------------ Autoscroll mentre arrossegues ------------------
    // Funció que fa autoscroll si el punter està prop de la vora del container (room).
    let autoScrollInterval = null;
    function startAutoScroll(direction, speed=8){
      stopAutoScroll();
      autoScrollInterval = setInterval(()=>{ room.scrollBy({ top: direction * speed, behavior: 'auto' }); }, 50);
    }
    function stopAutoScroll(){ if(autoScrollInterval){ clearInterval(autoScrollInterval); autoScrollInterval = null; } }

    function activateAutoScrollAndWheel(){
      // mousemove per detectar posició i iniciar autoscroll
      window.addEventListener('dragover', handleDragOver, { passive:false });
      // permet usar roda del ratolí per fer scroll mentre està arrossegant
      window.addEventListener('wheel', handleWheelWhileDragging, { passive:false });
    }
    function deactivateAutoScrollAndWheel(){
      window.removeEventListener('dragover', handleDragOver);
      window.removeEventListener('wheel', handleWheelWhileDragging);
      stopAutoScroll();
    }

    function handleDragOver(e){
      // mantenim preventDefault perquè el drop funcioni i per controlar el scroll
      e.preventDefault();
      const rect = room.getBoundingClientRect();
      const margin = 80; // zona a partir de la qual s'activa l'autoscroll
      if(e.clientY > rect.bottom - margin){
        // a prop de la vora inferior -> baixar
        startAutoScroll(1, Math.min(20, Math.max(6, (e.clientY - (rect.bottom - margin))/4)));
      } else if(e.clientY < rect.top + margin){
        // a prop de la vora superior -> pujar
        startAutoScroll(-1, Math.min(20, Math.max(6, ((rect.top + margin) - e.clientY)/4)));
      } else {
        stopAutoScroll();
      }
    }

    function handleWheelWhileDragging(e){
      if(!isDraggingInstrument) return;
      // deixem que la roda mogui la sala encara que estiguis arrossegant
      e.preventDefault();
      // scroll local del container
      room.scrollBy({ top: e.deltaY, left: 0, behavior: 'auto' });
    }

    // ------------------ Fi autoscroll ------------------

    // Tot llest
  </script>
</body>
</html>
