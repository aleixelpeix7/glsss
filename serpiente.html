<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Joc de la Serp</title>
  <style>
    :root { --wrap-w:400px; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:#f0f0f0;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      padding:18px 8px;
      color:#222;
    }
    h1{ margin:0; font-size:20px; }
    #gameWrap {
      position:relative;
      width:var(--wrap-w);
    }
    canvas {
      width:100%;
      height:auto;
      display:block;
      background:#222;
      border:2px solid #555;
    }
    #score { color:#444; font-size:14px; margin:6px 0 0 0; }

    .canvas-button {
      position:absolute;
      background:#fff;
      color:#111;
      border:1px solid #888;
      padding:8px 12px;
      font-size:14px;
      cursor:pointer;
      border-radius:6px;
      box-shadow:0 2px 6px rgba(0,0,0,0.25);
      user-select:none;
      z-index:20;
      transform:translateX(-50%);
      white-space:nowrap;
    }
    .hidden{ display:none; }
  </style>
</head>
<body>
  <h1>üêç Joc de la Serp</h1>

  <div id="gameWrap">
    <canvas id="gameCanvas" width="400" height="400"></canvas>
    <button id="startButton" class="canvas-button hidden" aria-label="Jugar">‚ñ∂Ô∏è Jugar</button>
    <button id="pauseContinue" class="canvas-button hidden" aria-label="Continuar">üîÑ Continuar</button>
    <button id="pauseReset" class="canvas-button hidden" aria-label="Reiniciar">üîÅ Reiniciar</button>
    <button id="gameOverReset" class="canvas-button hidden" aria-label="Reiniciar final">üîÅ Reiniciar</button>
  </div>

  <p id="score">Puntuaci√≥: 0</p>

  <script>
    const wrap = document.getElementById('gameWrap');
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const startButton = document.getElementById('startButton');
    const pauseContinue = document.getElementById('pauseContinue');
    const pauseReset = document.getElementById('pauseReset');
    const gameOverReset = document.getElementById('gameOverReset');
    const scoreEl = document.getElementById('score');

    const INTERNAL_W = canvas.width;
    const INTERNAL_H = canvas.height;
    const gridSize = 20;
    const tileCountX = INTERNAL_W / gridSize;
    const tileCountY = INTERNAL_H / gridSize;

    let snake = null;
    let direction = {x:0,y:0};
    let nextDirection = {x:0,y:0};
    let apple = {x:5,y:5};
    let score = 0;
    let gameInterval = null;
    let paused = false;
    let gameStarted = false;
    let gameOver = false;

    const SPEEDS = { slow:300, normal:200, fast:100 };
    let selectedSpeedKey = 'normal';
    let snakeSpeed = SPEEDS[selectedSpeedKey];

    const startMenuRect = { x:50, y:80, w:300, h:240 };
    const pauseMenuRect = { x:50, y:100, w:300, h:200 };
    const gameOverRect = { x:50, y:100, w:300, h:200 };

    function updateScore(){ scoreEl.textContent = 'Puntuaci√≥: ' + score; }
    function clearIntervalSafe(){ if(gameInterval){ clearInterval(gameInterval); gameInterval = null; } }

    function placeApple(){
      let tries = 0;
      do {
        apple.x = Math.floor(Math.random() * tileCountX);
        apple.y = Math.floor(Math.random() * tileCountY);
        tries++;
        if(tries>1000) break;
      } while (snake && snake.some(s=>s.x===apple.x && s.y===apple.y));
    }

    function initSnake(){
      snake = [{x:10,y:10},{x:9,y:10}];
      direction = {x:0,y:0};
      nextDirection = {x:0,y:0};
      score = 0;
      updateScore();
    }

    function internalToWrapLeft(internalX){
      const wrapW = wrap.clientWidth;
      const scale = wrapW / INTERNAL_W;
      return internalX * scale;
    }
    function internalToWrapTop(internalY){
      const wrapH = wrap.clientHeight;
      const scale = wrapH / INTERNAL_H;
      return internalY * scale;
    }

    // positionStartButton below the panel (unchanged)
    function positionStartButton(){
      const internalX = startMenuRect.x + startMenuRect.w / 2;
      const internalY = startMenuRect.y + startMenuRect.h + 6;
      startButton.style.left = (internalToWrapLeft(internalX)) + 'px';
      startButton.style.top  = (internalToWrapTop(internalY) + 8)  + 'px';
      startButton.style.transform = 'translateX(-50%)';
    }

    // pause buttons moved closer to center and slightly lowered compared to previous (lower = larger internalY)
    function positionPauseButtons(){
      const panelCenterX = pauseMenuRect.x + pauseMenuRect.w / 2;
      const offset = 60;
      const leftC_internal = panelCenterX - offset;
      const leftR_internal = panelCenterX + offset;
      const top_internal = pauseMenuRect.y + pauseMenuRect.h - 56; // lowered a bit (was -96 earlier)
      pauseContinue.style.left = internalToWrapLeft(leftC_internal) + 'px';
      pauseContinue.style.top  = internalToWrapTop(top_internal) + 'px';
      pauseReset.style.left    = internalToWrapLeft(leftR_internal) + 'px';
      pauseReset.style.top     = internalToWrapTop(top_internal) + 'px';
      pauseContinue.style.transform = 'translateX(-50%)';
      pauseReset.style.transform = 'translateX(-50%)';
    }

    // game over button moved down a bit and centered (lower = larger internalY)
    function positionGameOverButton(){
      const internalX = gameOverRect.x + gameOverRect.w / 2;
      const internalY = gameOverRect.y + gameOverRect.h - 72; // lowered from -110 to -72
      gameOverReset.style.left = internalToWrapLeft(internalX) + 'px';
      gameOverReset.style.top  = internalToWrapTop(internalY) + 'px';
      gameOverReset.style.transform = 'translateX(-50%)';
    }

    function showStartButton(){ startButton.classList.remove('hidden'); }
    function hideStartButton(){ startButton.classList.add('hidden'); }
    function showPauseButtons(){ pauseContinue.classList.remove('hidden'); pauseReset.classList.remove('hidden'); }
    function hidePauseButtons(){ pauseContinue.classList.add('hidden'); pauseReset.classList.add('hidden'); }
    function showGameOverButton(){ gameOverReset.classList.remove('hidden'); }
    function hideGameOverButton(){ gameOverReset.classList.add('hidden'); }
    function hideAllButtons(){ hideStartButton(); hidePauseButtons(); hideGameOverButton(); }

    function draw(){
      ctx.clearRect(0,0,INTERNAL_W,INTERNAL_H);
      ctx.fillStyle = '#222';
      ctx.fillRect(0,0,INTERNAL_W,INTERNAL_H);

      if(snake){
        for(let i=0;i<snake.length;i++){
          const p = snake[i];
          ctx.fillStyle = '#0f0';
          ctx.fillRect(p.x * gridSize, p.y * gridSize, gridSize-2, gridSize-2);
        }
        if(snake.length>0){
          const head = snake[0];
          const cellX = head.x * gridSize;
          const cellY = head.y * gridSize;
          const eyeSize = 4;
          let e1 = {x: cellX + 2, y: cellY + 4};
          let e2 = {x: cellX + 2, y: cellY + 12};
          if(direction.x === 1){
            e1 = {x: cellX + (gridSize - 6), y: cellY + 4};
            e2 = {x: cellX + (gridSize - 6), y: cellY + 12};
          } else if(direction.x === -1){
            e1 = {x: cellX + 2, y: cellY + 4};
            e2 = {x: cellX + 2, y: cellY + 12};
          } else if(direction.y === -1){
            e1 = {x: cellX + 6, y: cellY + 2};
            e2 = {x: cellX + 14, y: cellY + 2};
          } else if(direction.y === 1){
            e1 = {x: cellX + 6, y: cellY + (gridSize - 6)};
            e2 = {x: cellX + 14, y: cellY + (gridSize - 6)};
          }
          ctx.fillStyle = '#00f';
          ctx.fillRect(e1.x, e1.y, eyeSize, eyeSize);
          ctx.fillRect(e2.x, e2.y, eyeSize, eyeSize);
        }
      }

      if(gameStarted){
        ctx.fillStyle = '#f00';
        ctx.fillRect(apple.x * gridSize, apple.y * gridSize, gridSize-2, gridSize-2);
      }

      if(gameOver){
        drawGameOverMenu();
      } else {
        if(!gameStarted) drawStartMenu();
        if(paused) drawPauseMenu();
      }
    }

    function drawStartMenu(){
      ctx.fillStyle = 'rgba(0,0,0,0.75)';
      ctx.fillRect(startMenuRect.x, startMenuRect.y, startMenuRect.w, startMenuRect.h);
      ctx.fillStyle = '#fff';
      ctx.font = '18px system-ui, sans-serif';
      ctx.fillText('Benvingut al joc de la serp!', startMenuRect.x + 20, startMenuRect.y + 38);
      ctx.font = '14px system-ui, sans-serif';
      ctx.fillText('Selecciona la velocitat:', startMenuRect.x + 20, startMenuRect.y + 72);

      const baseY = startMenuRect.y + 110;
      const cx = startMenuRect.x + 50;
      const gap = 80;
      drawSpeedBox(cx, baseY, 'üê¢', 'slow');
      drawSpeedBox(cx + gap, baseY, '‚öñÔ∏è', 'normal');
      drawSpeedBox(cx + gap*2, baseY, 'üöÄ', 'fast');

      ctx.fillStyle = '#ccc';
      ctx.font = '12px system-ui, sans-serif';
      ctx.fillText('Fes clic sobre una icona per canviar la velocitat.', startMenuRect.x + 28, startMenuRect.y + startMenuRect.h - 28);

      positionStartButton();
      showStartButton();
    }

    function drawSpeedBox(x,y,icon,key){
      const w = 54, h = 48;
      ctx.fillStyle = 'rgba(255,255,255,0.06)';
      ctx.fillRect(x, y, w, h);
      if(selectedSpeedKey === key){
        ctx.strokeStyle = '#7af';
        ctx.lineWidth = 2;
        ctx.strokeRect(x+1, y+1, w-2, h-2);
      } else {
        ctx.strokeStyle = 'rgba(255,255,255,0.06)';
        ctx.lineWidth = 1;
        ctx.strokeRect(x+1, y+1, w-2, h-2);
      }
      ctx.font = '22px system-ui, sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillStyle = '#fff';
      ctx.fillText(icon, x + w/2, y + h/2 - 2);
      ctx.textAlign = 'start';
      ctx.textBaseline = 'alphabetic';
    }

    function drawPauseMenu(){
      ctx.fillStyle = 'rgba(0,0,0,0.75)';
      ctx.fillRect(pauseMenuRect.x, pauseMenuRect.y, pauseMenuRect.w, pauseMenuRect.h);
      ctx.fillStyle = '#fff';
      ctx.font = '20px system-ui, sans-serif';
      ctx.fillText('‚è∏ Joc en pausa', pauseMenuRect.x + 80, pauseMenuRect.y + 40);
      ctx.font = '16px system-ui, sans-serif';
      ctx.fillText('Puntuaci√≥', pauseMenuRect.x + 120, pauseMenuRect.y + 88);
      ctx.font = '34px system-ui, sans-serif';
      ctx.fillStyle = '#7af';
      ctx.fillText(String(score), pauseMenuRect.x + 160, pauseMenuRect.y + 130);

      positionPauseButtons();
      showPauseButtons();
    }

    function drawGameOverMenu(){
      ctx.fillStyle = 'rgba(0,0,0,0.75)';
      ctx.fillRect(gameOverRect.x, gameOverRect.y, gameOverRect.w, gameOverRect.h);
      ctx.fillStyle = '#fff';
      ctx.font = '20px system-ui, sans-serif';
      ctx.fillText('üíÄ Has perdut!', gameOverRect.x + 110, gameOverRect.y + 48);
      ctx.font = '18px system-ui, sans-serif';
      ctx.fillText('Puntuaci√≥ final: ' + score, gameOverRect.x + 100, gameOverRect.y + 92);
      positionGameOverButton();
      showGameOverButton();
    }

    function getWrapScale(){
      const wrapW = wrap.clientWidth;
      const wrapH = wrap.clientHeight;
      return { wrapW, wrapH, scaleX: wrapW / INTERNAL_W, scaleY: wrapH / INTERNAL_H };
    }

    canvas.addEventListener('click', (ev)=>{
      const { wrapW, wrapH, scaleX, scaleY } = getWrapScale();
      const rect = canvas.getBoundingClientRect();
      const internalX = Math.floor((ev.clientX - rect.left) / scaleX);
      const internalY = Math.floor((ev.clientY - rect.top) / scaleY);

      if(!gameStarted && !gameOver){
        if(pointInside(internalX, internalY, startMenuRect)){
          const baseY = startMenuRect.y + 110;
          const cx = startMenuRect.x + 50;
          const gap = 80;
          const boxes = [
            {key:'slow', x:cx, y:baseY, w:54, h:48},
            {key:'normal', x:cx+gap, y:baseY, w:54, h:48},
            {key:'fast', x:cx+gap*2, y:baseY, w:54, h:48}
          ];
          for(const b of boxes){
            if(pointInside(internalX, internalY, {x:b.x,y:b.y,w:b.w,h:b.h})){
              selectedSpeedKey = b.key;
              snakeSpeed = SPEEDS[selectedSpeedKey];
              draw();
              return;
            }
          }
        }
        return;
      }

      if(paused){
        if(pointInside(internalX, internalY, pauseMenuRect)){
          return;
        }
      }

      if(gameOver){
        return;
      }
    });

    function pointInside(px,py, rect){
      return px >= rect.x && px <= rect.x + rect.w && py >= rect.y && py <= rect.y + rect.h;
    }

    startButton.addEventListener('click', ()=>{
      snakeSpeed = SPEEDS[selectedSpeedKey];
      startGame();
    });
    pauseContinue.addEventListener('click', ()=> resumeGame());
    pauseReset.addEventListener('click', ()=> { resetToMenu(); });
    gameOverReset.addEventListener('click', ()=> {
      hideGameOverButton();
      gameOver = false;
      resetToMenu();
    });

    document.addEventListener('keydown', (e)=>{
      if(!gameStarted){
        if(e.key === 'Enter' && !gameOver){
          snakeSpeed = SPEEDS[selectedSpeedKey];
          startGame();
        }
        return;
      }

      if(e.key === 'Escape'){
        pauseGame();
        return;
      }

      if(paused){
        if(e.key === 'c' || e.key === 'C'){ resumeGame(); return; }
        if(e.key === 'r' || e.key === 'R'){ resetToMenu(); return; }
        return;
      }

      if(e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W'){
        if(direction.y !== 1) nextDirection = {x:0,y:-1};
      } else if(e.key === 'ArrowDown' || e.key === 's' || e.key === 'S'){
        if(direction.y !== -1) nextDirection = {x:0,y:1};
      } else if(e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A'){
        if(direction.x !== 1) nextDirection = {x:-1,y:0};
      } else if(e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D'){
        if(direction.x !== -1) nextDirection = {x:1,y:0};
      }
    });

    function startGame(){
      gameStarted = true;
      paused = false;
      gameOver = false;
      hideAllButtons();
      initSnake();
      placeApple();
      direction = {x:1,y:0};
      nextDirection = {x:1,y:0};
      snakeSpeed = SPEEDS[selectedSpeedKey];
      clearIntervalSafe();
      gameInterval = setInterval(gameLoop, snakeSpeed);
      draw();
    }

    function pauseGame(){
      if(!gameStarted || paused) return;
      paused = true;
      clearIntervalSafe();
      draw();
    }

    function resumeGame(){
      if(!gameStarted || !paused) return;
      paused = false;
      hideAllButtons();
      clearIntervalSafe();
      gameInterval = setInterval(gameLoop, snakeSpeed);
      draw();
    }

    function resetToMenu(){
      clearIntervalSafe();
      gameStarted = false;
      paused = false;
      gameOver = false;
      snake = null;
      direction = {x:0,y:0};
      nextDirection = {x:0,y:0};
      score = 0;
      updateScore();
      placeApple();
      hideAllButtons();
      draw();
      drawStartMenu();
      positionStartButton();
      showStartButton();
    }

    function gameLoop(){
      if(!snake) return;
      if(!(nextDirection.x === -direction.x && nextDirection.y === -direction.y)){
        if(nextDirection.x !== direction.x || nextDirection.y !== direction.y){
          direction = {...nextDirection};
        }
      }
      if(direction.x === 0 && direction.y === 0) return;

      const head = { x: snake[0].x + direction.x, y: snake[0].y + direction.y };

      if(head.x < 0 || head.x >= tileCountX || head.y < 0 || head.y >= tileCountY ||
         snake.some(p => p.x === head.x && p.y === head.y)){
        clearIntervalSafe();
        gameStarted = false;
        paused = false;
        gameOver = true;
        hideAllButtons();
        draw();
        drawGameOverMenu();
        return;
      }

      snake.unshift(head);
      if(head.x === apple.x && head.y === apple.y){
        score++;
        updateScore();
        placeApple();
      } else {
        snake.pop();
      }
      draw();
    }

    function updateButtonPositions(){
      if(!gameStarted && !gameOver) positionStartButton();
      if(paused) positionPauseButtons();
      if(gameOver) positionGameOverButton();
    }
    window.addEventListener('resize', updateButtonPositions);
    window.addEventListener('orientationchange', updateButtonPositions);

    function initDisplay(){
      snake = null;
      direction = {x:0,y:0};
      nextDirection = {x:0,y:0};
      score = 0;
      updateScore();
      placeApple();
      draw();
      drawStartMenu();
      positionStartButton();
      showStartButton();
    }
    initDisplay();

    const posInterval = setInterval(()=> { updateButtonPositions(); }, 120);
    window.addEventListener('beforeunload', ()=>{ clearInterval(posInterval); clearIntervalSafe(); });
  </script>
</body>
</html>
