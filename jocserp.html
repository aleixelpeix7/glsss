<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Joc de la Serp</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:#f0f0f0;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      padding:18px 8px;
      color:#222;
    }
    h1 { margin:0; font-size:20px; }
    #gameWrap{ position:relative; width:400px; }
    canvas{
      width:100%;
      height:auto;
      background:#222;
      border:2px solid #555;
      display:block;
    }
    #score { color:#444; font-size:14px; margin:6px 0 0 0; }
    .canvas-button {
      position:absolute;
      background:#fff;
      color:#111;
      border:1px solid #888;
      padding:8px 12px;
      font-size:14px;
      cursor:pointer;
      border-radius:6px;
      box-shadow:0 2px 6px rgba(0,0,0,0.25);
      user-select:none;
      z-index:20;
    }
    .hidden{ display:none; }
  </style>
</head>
<body>
  <h1>üêç Joc de la Serp</h1>
  <div id="gameWrap">
    <canvas id="gameCanvas" width="400" height="400"></canvas>
    <button id="startButton" class="canvas-button hidden" aria-label="Jugar">‚ñ∂Ô∏è Jugar</button>
    <button id="pauseContinue" class="canvas-button hidden" aria-label="Continuar">üîÑ Continuar</button>
    <button id="pauseReset" class="canvas-button hidden" aria-label="Reiniciar">üîÅ Reiniciar</button>
  </div>
  <p id="score">Puntuaci√≥: 0</p>

  <script>
    /* Joc complet integrat */
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const wrap = document.getElementById('gameWrap');
    const startButton = document.getElementById('startButton');
    const pauseContinue = document.getElementById('pauseContinue');
    const pauseReset = document.getElementById('pauseReset');
    const scoreEl = document.getElementById('score');

    // Internal canvas size (actual drawing resolution)
    const INTERNAL_W = canvas.width;
    const INTERNAL_H = canvas.height;

    const gridSize = 20;
    const tileCountX = INTERNAL_W / gridSize;
    const tileCountY = INTERNAL_H / gridSize;

    let snake = null; // null until game starts
    let direction = {x:0,y:0};
    let nextDirection = {x:0,y:0};
    let apple = {x:5,y:5};
    let score = 0;
    let gameInterval = null;
    let paused = false;
    let gameStarted = false;

    const SPEEDS = { slow:300, normal:200, fast:100 };
    let selectedSpeedKey = 'normal';
    let snakeSpeed = SPEEDS[selectedSpeedKey];

    // Menu rectangles in internal coordinates
    const startMenuRect = { x:50, y:80, w:300, h:240 };
    const pauseMenuRect = { x:50, y:100, w:300, h:200 };

    // ---------- helpers ----------
    function initSnake(){
      snake = [ {x:10,y:10}, {x:9,y:10} ];
      direction = {x:0,y:0};
      nextDirection = {x:0,y:0};
      score = 0;
      updateScore();
    }

    function updateScore(){ scoreEl.textContent = 'Puntuaci√≥: ' + score; }

    function placeApple(){
      let tries = 0;
      do {
        apple.x = Math.floor(Math.random() * tileCountX);
        apple.y = Math.floor(Math.random() * tileCountY);
        tries++;
        if(tries>500) break;
      } while (snake && snake.some(s=>s.x===apple.x && s.y===apple.y));
    }

    function runInterval(){
      if(gameInterval) clearInterval(gameInterval);
      gameInterval = setInterval(gameLoop, snakeSpeed);
    }

    function clearIntervalSafe(){
      if(gameInterval) { clearInterval(gameInterval); gameInterval = null; }
    }

    // ---------- game control ----------
    function startGame(){
      gameStarted = true;
      paused = false;
      hideButtons();
      initSnake();
      placeApple();
      direction = {x:1,y:0};
      nextDirection = {x:1,y:0};
      snakeSpeed = SPEEDS[selectedSpeedKey];
      runInterval();
      draw(); // ensure UI updated
    }

    function pauseGame(){
      if(!gameStarted || paused) return;
      paused = true;
      clearIntervalSafe();
      draw(); // show pause menu
    }

    function resumeGame(){
      if(!gameStarted || !paused) return;
      paused = false;
      hideButtons();
      runInterval();
    }

    function resetToMenu(){
      clearIntervalSafe();
      gameStarted = false;
      paused = false;
      snake = null;
      direction = {x:0,y:0};
      nextDirection = {x:0,y:0};
      score = 0;
      updateScore();
      placeApple();
      hideButtons();
      draw();
      drawStartMenu();
      positionStartButton();
      showStartButton();
    }

    // ---------- core loop ----------
    function gameLoop(){
      if(!snake) return;
      // apply nextDirection if valid (avoid 180)
      if(!(nextDirection.x === -direction.x && nextDirection.y === -direction.y)){
        if(nextDirection.x !== direction.x || nextDirection.y !== direction.y){
          direction = {...nextDirection};
        }
      }
      if(direction.x === 0 && direction.y === 0) return;

      const head = { x: snake[0].x + direction.x, y: snake[0].y + direction.y };

      // collisions
      if(head.x < 0 || head.x >= tileCountX || head.y < 0 || head.y >= tileCountY ||
         snake.some(p => p.x === head.x && p.y === head.y)){
        // death -> go to menu
        resetToMenu();
        return;
      }

      snake.unshift(head);

      if(head.x === apple.x && head.y === apple.y){
        score++;
        updateScore();
        placeApple();
      } else {
        snake.pop();
      }

      draw();
    }

    // ---------- drawing ----------
    function draw(){
      // clear internal canvas
      ctx.clearRect(0,0,INTERNAL_W,INTERNAL_H);
      // background
      ctx.fillStyle = '#222';
      ctx.fillRect(0,0,INTERNAL_W,INTERNAL_H);

      // draw snake only if exists
      if(snake){
        for(let i=0;i<snake.length;i++){
          const p = snake[i];
          ctx.fillStyle = '#0f0';
          ctx.fillRect(p.x * gridSize, p.y * gridSize, gridSize-2, gridSize-2);
        }

        // draw eyes on head oriented by direction
        if(snake.length>0){
          const head = snake[0];
          const cellX = head.x * gridSize;
          const cellY = head.y * gridSize;
          const eyeSize = 4;
          let e1 = {x: cellX + 2, y: cellY + 4};
          let e2 = {x: cellX + 2, y: cellY + 12};
          if(direction.x === 1){ // right
            e1 = {x: cellX + (gridSize - 6), y: cellY + 4};
            e2 = {x: cellX + (gridSize - 6), y: cellY + 12};
          } else if(direction.x === -1){ // left
            e1 = {x: cellX + 2, y: cellY + 4};
            e2 = {x: cellX + 2, y: cellY + 12};
          } else if(direction.y === -1){ // up
            e1 = {x: cellX + 6, y: cellY + 2};
            e2 = {x: cellX + 14, y: cellY + 2};
          } else if(direction.y === 1){ // down
            e1 = {x: cellX + 6, y: cellY + (gridSize - 6)};
            e2 = {x: cellX + 14, y: cellY + (gridSize - 6)};
          }
          ctx.fillStyle = '#00f';
          ctx.fillRect(e1.x, e1.y, eyeSize, eyeSize);
          ctx.fillRect(e2.x, e2.y, eyeSize, eyeSize);
        }
      }

      // draw apple
      ctx.fillStyle = '#f00';
      ctx.fillRect(apple.x * gridSize, apple.y * gridSize, gridSize-2, gridSize-2);

      // menus
      if(!gameStarted) drawStartMenu();
      if(paused) drawPauseMenu();
    }

    function drawStartMenu(){
      // dark panel
      ctx.fillStyle = 'rgba(0,0,0,0.75)';
      ctx.fillRect(startMenuRect.x, startMenuRect.y, startMenuRect.w, startMenuRect.h);
      // texts
      ctx.fillStyle = '#fff';
      ctx.font = '18px system-ui, sans-serif';
      ctx.fillText('Benvingut al joc de la serp!', startMenuRect.x + 20, startMenuRect.y + 38);
      ctx.font = '14px system-ui, sans-serif';
      ctx.fillText('Selecciona la velocitat:', startMenuRect.x + 20, startMenuRect.y + 72);

      // speed boxes
      const baseY = startMenuRect.y + 110;
      const cx = startMenuRect.x + 50;
      const gap = 80;
      drawSpeedBox(cx, baseY, 'üê¢', 'slow');
      drawSpeedBox(cx + gap, baseY, '‚öñÔ∏è', 'normal');
      drawSpeedBox(cx + gap*2, baseY, 'üöÄ', 'fast');

      ctx.fillStyle = '#ccc';
      ctx.font = '12px system-ui, sans-serif';
      ctx.fillText('Fes clic sobre una icona per canviar la velocitat.', startMenuRect.x + 28, startMenuRect.y + startMenuRect.h - 28);

      // show start button positioned relative to canvas
      positionStartButton();
      showStartButton();
    }

    function drawSpeedBox(x,y,icon,key){
      const w = 54, h = 48;
      ctx.fillStyle = 'rgba(255,255,255,0.06)';
      ctx.fillRect(x, y, w, h);
      if(selectedSpeedKey === key){
        ctx.strokeStyle = '#7af';
        ctx.lineWidth = 2;
        ctx.strokeRect(x+1, y+1, w-2, h-2);
      } else {
        ctx.strokeStyle = 'rgba(255,255,255,0.06)';
        ctx.lineWidth = 1;
        ctx.strokeRect(x+1, y+1, w-2, h-2);
      }
      ctx.font = '22px system-ui, sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillStyle = '#fff';
      ctx.fillText(icon, x + w/2, y + h/2 - 2);
      ctx.textAlign = 'start';
      ctx.textBaseline = 'alphabetic';
    }

    function drawPauseMenu(){
      ctx.fillStyle = 'rgba(0,0,0,0.75)';
      ctx.fillRect(pauseMenuRect.x, pauseMenuRect.y, pauseMenuRect.w, pauseMenuRect.h);
      ctx.fillStyle = '#fff';
      ctx.font = '20px system-ui, sans-serif';
      ctx.fillText('‚è∏ Joc en pausa', pauseMenuRect.x + 80, pauseMenuRect.y + 40);
      ctx.font = '16px system-ui, sans-serif';
      ctx.fillText('Puntuaci√≥', pauseMenuRect.x + 120, pauseMenuRect.y + 88);
      ctx.font = '34px system-ui, sans-serif';
      ctx.fillStyle = '#7af';
      ctx.fillText(String(score), pauseMenuRect.x + 160, pauseMenuRect.y + 130);

      positionPauseButtons();
      showPauseButtons();
    }

    // ---------- positioning HTML buttons correctly (takes scale into account) ----------
    function getCanvasScale(){
      const rect = canvas.getBoundingClientRect();
      return { rect, scaleX: rect.width / INTERNAL_W, scaleY: rect.height / INTERNAL_H };
    }

    function positionStartButton(){
      const { rect, scaleX, scaleY } = getCanvasScale();
      const internalX = startMenuRect.x + startMenuRect.w/2 - 40; // approximate centre offset
      const internalY = startMenuRect.y + startMenuRect.h - 48;
      const left = rect.left + internalX * scaleX;
      const top  = rect.top  + internalY * scaleY;
      startButton.style.left = Math.round(left) + 'px';
      startButton.style.top  = Math.round(top) + 'px';
    }

    function positionPauseButtons(){
      const { rect, scaleX, scaleY } = getCanvasScale();
      const leftC_internal = pauseMenuRect.x + 40;
      const leftR_internal = pauseMenuRect.x + pauseMenuRect.w - 120;
      const top_internal = pauseMenuRect.y + pauseMenuRect.h - 56;
      pauseContinue.style.left = Math.round(rect.left + leftC_internal * scaleX) + 'px';
      pauseContinue.style.top  = Math.round(rect.top  + top_internal * scaleY) + 'px';
      pauseReset.style.left    = Math.round(rect.left + leftR_internal * scaleX) + 'px';
      pauseReset.style.top     = Math.round(rect.top  + top_internal * scaleY) + 'px';
    }

    function showStartButton(){ startButton.classList.remove('hidden'); }
    function hideStartButton(){ startButton.classList.add('hidden'); }
    function showPauseButtons(){ pauseContinue.classList.remove('hidden'); pauseReset.classList.remove('hidden'); }
    function hidePauseButtons(){ pauseContinue.classList.add('hidden'); pauseReset.classList.add('hidden'); }
    function showPauseMenu(){ draw(); drawPauseMenu(); }
    function hideButtons(){ hideStartButton(); hidePauseButtons(); }

    // ---------- canvas clicks (select speed) ----------
    canvas.addEventListener('click', (ev)=>{
      const { rect, scaleX, scaleY } = getCanvasScale();
      const internalX = Math.floor((ev.clientX - rect.left) / scaleX);
      const internalY = Math.floor((ev.clientY - rect.top)  / scaleY);

      if(!gameStarted){
        if(pointInside(internalX, internalY, startMenuRect)){
          const baseY = startMenuRect.y + 110;
          const cx = startMenuRect.x + 50;
          const gap = 80;
          const boxes = [
            {key:'slow', x:cx, y:baseY, w:54, h:48},
            {key:'normal', x:cx+gap, y:baseY, w:54, h:48},
            {key:'fast', x:cx+gap*2, y:baseY, w:54, h:48}
          ];
          for(const b of boxes){
            if(pointInside(internalX, internalY, {x:b.x,y:b.y,w:b.w,h:b.h})){
              selectedSpeedKey = b.key;
              snakeSpeed = SPEEDS[selectedSpeedKey];
              draw(); // update selection visual
              return;
            }
          }
        }
        return;
      }

      if(paused){
        if(pointInside(internalX, internalY, pauseMenuRect)){
          // leave interactions to HTML buttons
          return;
        }
      }
    });

    function pointInside(px,py, rect){
      return px >= rect.x && px <= rect.x + rect.w && py >= rect.y && py <= rect.y + rect.h;
    }

    // ---------- HTML button handlers ----------
    startButton.addEventListener('click', ()=>{
      snakeSpeed = SPEEDS[selectedSpeedKey];
      startGame();
    });

    pauseContinue.addEventListener('click', ()=> resumeGame());
    pauseReset.addEventListener('click', ()=> { resetToMenu(); });

    // ---------- keyboard ----------
    document.addEventListener('keydown', (e)=>{
      if(!gameStarted){
        if(e.key === 'Enter'){
          snakeSpeed = SPEEDS[selectedSpeedKey];
          startGame();
        }
        return;
      }

      if(e.key === 'Escape'){
        pauseGame();
        return;
      }

      if(paused){
        if(e.key === 'c' || e.key === 'C'){ resumeGame(); return; }
        if(e.key === 'r' || e.key === 'R'){ resetToMenu(); return; }
        return;
      }

      // direction keys (prevent 180)
      if(e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W'){
        if(direction.y !== 1) nextDirection = {x:0,y:-1};
      } else if(e.key === 'ArrowDown' || e.key === 's' || e.key === 'S'){
        if(direction.y !== -1) nextDirection = {x:0,y:1};
      } else if(e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A'){
        if(direction.x !== 1) nextDirection = {x:-1,y:0};
      } else if(e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D'){
        if(direction.x !== -1) nextDirection = {x:1,y:0};
      }
    });

    // update positions on resize/scroll
    window.addEventListener('resize', ()=> {
      if(!gameStarted) positionStartButton();
      if(paused) positionPauseButtons();
    });
    window.addEventListener('scroll', ()=> {
      if(!gameStarted) positionStartButton();
      if(paused) positionPauseButtons();
    });

    // ---------- initial display ----------
    function initDisplay(){
      snake = null; // ensure not visible
      direction = {x:0,y:0};
      nextDirection = {x:0,y:0};
      score = 0;
      updateScore();
      placeApple();
      draw();
      drawStartMenu();
      positionStartButton();
      showStartButton();
    }

    initDisplay();

    // keep button positions updated in case layout changes
    const posInterval = setInterval(()=> {
      if(!gameStarted) positionStartButton();
      if(paused) positionPauseButtons();
    }, 120);

    window.addEventListener('beforeunload', ()=>{
      clearInterval(posInterval);
      clearIntervalSafe();
    });
  </script>
</body>
</html>

