<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Salón de Ritmos — Graella modular</title>
  <style>
    :root {
      --bg:#1e1f24; --panel:#2b2f39; --room:#2b2f39; --text:#eaeaea;
      --accent:#ffd45e; --off:#656a77; --on:#4bd17b; --line:#3a3f4a;
    }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--text); font-family:system-ui, Arial, sans-serif; }
    header { padding:16px 20px; display:flex; align-items:center; justify-content:space-between; }
    header h1 { margin:0; font-size:20px; }
    #controls { display:flex; gap:12px; align-items:center; }
    #controls button, #controls input { background:var(--panel); color:var(--text); border:1px solid var(--line); padding:8px 12px; border-radius:8px; }
    #controls input[type="range"] { width:160px; }
    #room {
      background:var(--room); margin:0 20px 20px; border-radius:12px; position:relative; overflow:hidden;
      box-shadow:inset 0 0 0 1px var(--line);
      padding:16px;
    }

    /* Graella de 4 files: cercle buit + select + passos (32) */
    .grid {
      display:grid;
      grid-template-columns: 72px 160px 1fr;
      gap:14px 16px;
      align-items:center;
    }
    .row {
      display:contents; /* cada fila ocupa les 3 columnes */
    }

    /* Cercle buit per “col·locar” instrument */
    .slot {
      width:60px; height:60px; border-radius:50%;
      border:2px dashed #7c8291; background:transparent;
      display:flex; align-items:center; justify-content:center;
      color:#aeb4c2; font-size:12px; user-select:none;
    }
    .slot.filled { border-style:solid; border-color:#aeb4c2; color:#eaeaea; }

    /* Selector d'instrument a la dreta del cercle */
    .selector {
      display:flex; align-items:center; gap:8px;
    }
    .selector label { font-size:12px; color:#aeb4c2; }
    .selector select {
      background:var(--panel); color:var(--text);
      border:1px solid var(--line); padding:8px 10px; border-radius:8px; min-width:140px;
    }

    /* 32 passos ben compactes */
    .steps {
      display:grid;
      grid-template-columns: repeat(32, 22px);
      gap:6px;
      align-items:center;
    }
    .step {
      width:22px; height:22px; border-radius:6px;
      background:var(--off); cursor:pointer; border:1px solid var(--line);
      transition:transform 80ms ease, background 120ms ease;
    }
    .step:hover { transform:scale(1.06); }
    .step.active { background:var(--on); }
    .step.current { outline:2px solid var(--accent); }

    /* Línia separadora entre files per ordre visual */
    .grid-row-divider {
      grid-column: 1 / -1;
      height:1px; background:var(--line); opacity:0.5; margin:8px 0;
    }

    /* Peu amb llegenda */
    #legend { display:flex; gap:12px; align-items:center; color:#aeb4c2; font-size:12px; padding:0 20px 16px; }
    #legend span { display:inline-flex; align-items:center; gap:6px; }
    .dot { width:10px; height:10px; border-radius:50%; display:inline-block; }
  </style>
</head>
<body>
  <header>
    <h1>Salón de Ritmos — graella de 4 instruments</h1>
    <div id="controls">
      <button id="startStop">Iniciar</button>
      <label>BPM <input id="bpm" type="range" min="50" max="200" value="100"/></label>
      <span id="bpmVal">100</span>
    </div>
  </header>

  <div id="room" aria-label="Salón">
    <div class="grid" id="grid"></div>
  </div>

  <div id="legend">
    <span><span class="dot" style="background:var(--on)"></span>Activo</span>
    <span><span class="dot" style="background:var(--off)"></span>Inactivo</span>
    <span><span class="dot" style="background:var(--accent)"></span>Paso actual</span>
  </div>

  <script>
    // Audio context
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    const audio = new AudioCtx();

    // Sintetitzadors
    function playKick(time, gainMul=1) {
      const osc = audio.createOscillator();
      const gain = audio.createGain();
      osc.type = "sine";
      osc.frequency.setValueAtTime(150, time);
      osc.frequency.exponentialRampToValueAtTime(50, time + 0.12);
      gain.gain.setValueAtTime(1 * gainMul, time);
      gain.gain.exponentialRampToValueAtTime(0.001, time + 0.22);
      osc.connect(gain).connect(audio.destination);
      osc.start(time); osc.stop(time + 0.24);
    }
    function playSnare(time, gainMul=1) {
      const noiseBuf = audio.createBuffer(1, audio.sampleRate * 0.2, audio.sampleRate);
      const data = noiseBuf.getChannelData(0);
      for (let i=0;i<data.length;i++) data[i] = (Math.random()*2-1) * 0.6;
      const noise = audio.createBufferSource(); noise.buffer = noiseBuf;
      const bandpass = audio.createBiquadFilter(); bandpass.type = "bandpass"; bandpass.frequency.value = 1800;
      const gain = audio.createGain();
      gain.gain.setValueAtTime(0.8 * gainMul, time);
      gain.gain.exponentialRampToValueAtTime(0.001, time + 0.18);
      noise.connect(bandpass).connect(gain).connect(audio.destination);
      noise.start(time); noise.stop(time + 0.2);
    }
    function playHiHat(time, gainMul=1) {
      const noiseBuf = audio.createBuffer(1, audio.sampleRate * 0.08, audio.sampleRate);
      const data = noiseBuf.getChannelData(0);
      for (let i=0;i<data.length;i++) data[i] = (Math.random()*2-1) * 0.4;
      const noise = audio.createBufferSource(); noise.buffer = noiseBuf;
      const highpass = audio.createBiquadFilter(); highpass.type = "highpass"; highpass.frequency.value = 6000;
      const gain = audio.createGain();
      gain.gain.setValueAtTime(0.5 * gainMul, time);
      gain.gain.exponentialRampToValueAtTime(0.001, time + 0.08);
      noise.connect(highpass).connect(gain).connect(audio.destination);
      noise.start(time); noise.stop(time + 0.1);
    }
    function playClap(time, gainMul=1) {
      const burst = (t, amp) => {
        const noiseBuf = audio.createBuffer(1, audio.sampleRate * 0.06, audio.sampleRate);
        const d = noiseBuf.getChannelData(0);
        for (let i=0;i<d.length;i++) d[i] = (Math.random()*2-1) * 0.5;
        const src = audio.createBufferSource(); src.buffer = noiseBuf;
        const gain = audio.createGain(); gain.gain.setValueAtTime(amp * gainMul, t);
        gain.gain.exponentialRampToValueAtTime(0.001, t + 0.07);
        src.connect(gain).connect(audio.destination);
        src.start(t); src.stop(t + 0.08);
      };
      burst(time, 0.6); burst(time+0.02, 0.5); burst(time+0.04, 0.4);
    }

    const synthByName = { kick: playKick, snare: playSnare, hihat: playHiHat, clap: playClap };

    // Estat del seqüenciador
    const STEPS = 32;
    let bpm = 100;
    let isPlaying = false;
    let schedulerTimer = null;
    let currentStep = 0;

    const bpmInput = document.getElementById("bpm");
    const bpmVal = document.getElementById("bpmVal");
    bpmInput.addEventListener("input", () => { bpm = parseInt(bpmInput.value,10); bpmVal.textContent = bpm; });

    const startStopBtn = document.getElementById("startStop");
    startStopBtn.addEventListener("click", async () => {
      if (!isPlaying) {
        await audio.resume();
        isPlaying = true; startStopBtn.textContent = "Parar";
        scheduleTick();
      } else {
        isPlaying = false; startStopBtn.textContent = "Iniciar";
        clearTimeout(schedulerTimer); schedulerTimer = null;
        document.querySelectorAll(".step").forEach(s => s.classList.remove("current"));
        currentStep = 0;
      }
    });

    // Construcció de la graella: 4 files
    const grid = document.getElementById("grid");
    const rows = []; // {slotEl, selectEl, pattern:Array<bool>, stepEls:HTMLElement[]}

    const instrumentNames = { kick: "Kick", snare: "Snare", hihat: "HiHat", clap: "Clap" };

    for (let r=0; r<4; r++) {
      // Cercle buit (slot)
      const slot = document.createElement("div");
      slot.className = "slot";
      slot.textContent = "—";
      // Selector d'instrument
      const selectorWrap = document.createElement("div");
      selectorWrap.className = "selector";
      const label = document.createElement("label");
      label.textContent = "Instrument";
      const select = document.createElement("select");
      ["kick","snare","hihat","clap"].forEach(opt => {
        const o = document.createElement("option");
        o.value = opt; o.textContent = instrumentNames[opt];
        select.appendChild(o);
      });
      selectorWrap.appendChild(label);
      selectorWrap.appendChild(select);

      // Passos (32)
      const steps = document.createElement("div");
      steps.className = "steps";
      const pattern = new Array(STEPS).fill(false);
      const stepEls = [];

      for (let i=0; i<STEPS; i++) {
        const cell = document.createElement("div");
        cell.className = "step";
        cell.dataset.index = i;
        cell.addEventListener("click", () => {
          pattern[i] = !pattern[i];
          cell.classList.toggle("active");
        });
        steps.appendChild(cell);
        stepEls.push(cell);
      }

      // Interacció: quan tries instrument, marquem el slot com “omplert”
      const updateSlot = () => {
        slot.classList.add("filled");
        slot.textContent = instrumentNames[select.value];
      };
      select.addEventListener("change", updateSlot);
      // Inicial: mostrar instrument per defecte al slot
      updateSlot();

      // Append en la graella
      grid.appendChild(slot);
      grid.appendChild(selectorWrap);
      grid.appendChild(steps);

      // Divisor visual entre files
      if (r < 3) {
        const divider = document.createElement("div");
        divider.className = "grid-row-divider";
        grid.appendChild(divider);
      }

      rows.push({ slotEl: slot, selectEl: select, pattern, stepEls });
    }

    // Scheduler
    function scheduleTick() {
      const spb = 60 / bpm;      // segons per negra
      const stepDur = spb / 4;   // 16é: 4 passos per negra; amb 32 passos, és semicorxera
      const now = audio.currentTime;

      rows.forEach(row => {
        // marca visual del pas actual
        row.stepEls.forEach((el,i) => el.classList.toggle("current", i === currentStep));
        // dispara si el pas està actiu
        if (row.pattern[currentStep]) {
          const fn = synthByName[row.selectEl.value];
          if (fn) fn(now + 0.02, 1);
        }
      });

      currentStep = (currentStep + 1) % STEPS;
      schedulerTimer = setTimeout(scheduleTick, stepDur * 1000);
    }
  </script>
</body>
</html>
